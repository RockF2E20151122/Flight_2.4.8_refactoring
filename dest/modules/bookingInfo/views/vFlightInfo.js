"use strict";define(["cWidgetMember","cWidgetFactory","c","libs","mFlight","sFlight","cUI","flight/utility/utility",buildViewTemplatesPath("../modules/bookingInfo/templates/tFlight.html")],function(a,b,c,d,e,f,g,h,i){var j={FC:"退改签",set:"旅行套餐",instruction:"套餐说明",FcAndInstruction:"套餐及退改签说明",NOTICKET:"抱歉，您选择的价格舱位已售完，请重新查询选择其它价格舱位预订。"},k=c.base,l=b.create("Member"),m=f.FlightSelectedInfo.getInstance(),n=f.FlightSearchStore.getInstance(),o=(f.FlightDetailsStore.getInstance(),f.FlightOrderInfoStore.getInstance()),p=f.SalesObjectStore.getInstance(),q=f.UserStore.getInstance(),r=f.MdBookingStore.getInstance(),s=new c.base.Class({__propertys__:function(){this.viewName="FlightInfo",this.opts=this.opts||{},this.parentView=null},setBoxes:function(){this.flightInfoBox=this.viewPort.find("#flightInfo")},setTemplate:function(){this.viewPort.append(i),this.j_flightInfoOneway_tpl=_.template(this.viewPort.find(".j_flightInfoOneway_tpl").html()),this.j_flightInfoReturn_tpl=_.template(this.viewPort.find(".j_flightInfoReturn_tpl").html()),this.j_childrenAndBaby_tpl=_.template(this.viewPort.find(".j_childrenAndBaby_tpl").html())},changeOpts:function(a){this.opts=$.extend(!0,this.opts,a),this.viewPort=this.opts.viewPort,this.parentView=this.opts.parentView,this.stores=this.parentView.stores,this.models=this.parentView.models},initialize:function(a){this.changeOpts(a),this.setBoxes(),this.setTemplate(),this.fireEvents()},EVENTS:{GETFLIGHTDETAIL:"getFlightDetail",render:"render"},fireEvents:function(){},render:function(){var a=this.stores.selFlightInfoStore.get();if(!a)return this.parentView.showAlert(),!0;var b=this.initFlightInfoData(m,p,k,n,q);this.setHtml(b)},setHtml:function(a){this.flightInfoBox.empty();var b;if(!a||!a.items)return this.parentView.back("#list");var c=a.items[0].basicInfo,d=this.stores.flightSearchStore.getSearchDetails(0,"dcityName"),e=this.stores.flightSearchStore.getSearchDetails(0,"acityName");a.items.length>1?($(".j_flightTitle").removeClass("flight-h1twoline").html((c.dcname||d)+"-"+(c.acname||e)),b=this.j_flightInfoReturn_tpl(a)):($(".j_flightTitle").removeClass("flight-h1twoline").addClass("flight-h1twoline").html((c.dcname||d)+"-"+(c.acname||e)+"<br /><span>"+c.aname+c.flightNo+"</span>"),b=this.j_flightInfoOneway_tpl(a)),this.flightInfoBox.html(b);var f=this,g=this.viewPort.find(".j_RC"),h=this.viewPort.find(".j_policy");a.items.length>1?a.items[0].bIsPackage&&a.items[1].bIsPackage?g.html(j.instruction):(a.items[0].bIsPackage||a.items[1].bIsPackage)&&g.html(j.FcAndInstruction):a.items[0].bIsPackage&&(g.html(j.instruction),h.html(j.set)),h.removeClass("js_hide"),this.viewPort.find(".flight-loginline").on("click",f.bookLogin.bind(f)),g.on("click",f.tgBoxAction.bind(f))},bookLogin:function(){r.setAttr("IsClickLogin",!0),o.setAttr("selInsure","1"),q.isLogin()||(this.parentView.showLoading(),l.memberLogin({param:"from="+encodeURIComponent("/webapp/flight/#bookinginfo")+"&t=1"}))},renderList:function(a){var b=o.get(),c=q.getUser();b=b?b:{},a.cDate=k.Date,a.order=b;var d=n.get(),e=m.get();a.selectedFlight=e,a.flightSearch=d.items[0],a.user=c;var f=p.get();a._sales=f,this.setHtml(a)},initFlightInfoData:function(a,b,c,d,e){for(var f=a.get(),g={items:[],_sales:b.get(),pCount:1,cDate:c.Date,selectedFlight:f,flightSearch:d.getAttr("items")[0],user:e.getUser()},h=[],i=f.depart||{},j=f.arrive,k=[i,j],l=j?2:1,m=0;l>m;m++)h[m]={basicInfo:{aCtyCode:k[m].flight.aPortCode,aCtyId:null,aPortCode:k[m].flight.aPortCode,aTerminal:k[m].flight.aTerminal,aTime:k[m].flight.aTime,aaname:k[m].flight.aaname,acname:"",agreementId:"",airlineCode:k[m].flight.airlineCode,aname:k[m].flight.aname,channel:"",ctinfo:k[m].flight.ctinfo,dCtyCode:"BJS",dCtyId:"1",dPortCode:k[m].flight.dPortCode,dTerminal:k[m].flight.dTerminal,dTime:k[m].flight.dTime,daname:k[m].flight.daname,dcname:"",flag:k[m].flight.flag,flightNo:k[m].flight.flightNo,planeType:k[m].flight.planeType,puncRate:k[m].flight.puncRate,polid:k[m].cabin.pid},ext:"",policy:{isAddChd:null,activityBM:"",babyPolicy:null,cardTypes:"",childPolicy:null,isApplyChild:!0,"class":k[m].cabin.class,classForDisp:k[m].cabin.classForDisp,discount:k[m].cabin.discount,price:k[m].cabin.price,sPrice:k[m].cabin.price,fuelCost:"",tax:"",minNum:1,payments:[],productType:null,qty:10,subclass:k[m].cabin.subClass,subclassForDisp:null},proRmk:"",rmk:{notice:"",ticketTitle:"",ticketBody:"",refNote:"",rerNote:"",endNote:"",ext:null,specialClass:null},routingIdx:"",stopCities:k[m].flight.stopCities,prodRmk:""};return g.items=h,g},tgBoxAction:function(a){if(r.setAttr("IsCheckTGQ",!0),!this.parentView.isShowLoad){this.addBabyAndChildrenTips(this.parentView[this.parentView.EVENTS.hasChildrenOrBaby]()?!1:!0);var b=$(a.currentTarget),c=$(".flight-pnttips").html(),d=$(".flight-rtntips").html(),e=(b.siblings(".flight-pnttips"),b.siblings(".flight-rtntips"),c+"<p>"+d+"</p><br />");h.popUp(this.viewPort,e)}},addBabyAndChildrenTips:function(a){var b=this.j_childrenAndBaby_tpl();if(a){if(this.viewPort.find(".flight-pnttips").find(".j_childrenAndBaby").length>0)return;this.viewPort.find(".flight-pnttips").append(b)}else this.viewPort.find(".flight-pnttips").find(".j_childrenAndBaby").remove()},getFlightDetail:function(a){var b=this,c=this.parentView,d=this.stores.passengerQueryStore;this.models.flightDetailModel.excute(function(e){if(!(e&&e.items&&e.items.length))return c.alert=new g.Alert({title:"提示信息",message:j.NOTICKET,buttons:[{text:"知道了",click:function(){this.hide()}}]}),void c.alert.show();var f=b.stores.selFlightInfoStore.get();e.items[0].policy.rebateAmt=f.depart.cabin.rebateAmt||0,e.items.length>1&&(e.items[1].policy.rebateAmt=f.arrive.cabin.rebateAmt||0);var h=d.get();DataControl.updatePassengersTicketType(h),c.trigger(c.EVENTS.FILTERPASSENGERS,h?h.passengers:null);var i=DataControl.getSelectedPassengers();e.passengers=i,e.pCount=i.length,d.setAttr("validSelCount",e.pCount),a&&a(e),c.renderList(e),this.viewPort.find(".j_hd").removeClass("js_hide"),b.parentView.hideLoading()},function(a){var d=a.msg?a.msg:"啊哦,数据加载出错了!";30001==a.res?(c.alert=new g.Alert({title:"提示信息",message:j.NOTICKET,buttons:[{text:"知道了",click:function(){this.hide(),n.setAttr("fullCabin",!0),c.back("list")}}]}),c.alert.show()):c.showAlert(d),b.parentView.hideLoading()},!1,this)}});return s});