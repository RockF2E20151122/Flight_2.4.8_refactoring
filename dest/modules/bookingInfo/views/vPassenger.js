"use strict";define(["c","libs","mPassenger","vCorporater1","flight/utility/utility","MultipleScrollList",buildViewTemplatesPath("../modules/bookingInfo/templates/tPassenger.html")],function(a,b,c,d,e,f,g){var h={ADULT:1,CHILD:2,BABY:3,NEWBORN:4},i=new a.base.Class({__propertys__:function(){this.viewName="Passenger",this.opts=this.opts||{},this.parentView=null},EVENTS:{hasChildrenOrBaby:"hasChildrenOrBaby"},changeOpts:function(a){this.opts=$.extend(!0,{},a),this.viewPort=this.opts.viewPort,this.parentView=this.opts.parentView,this.stores=this.parentView.stores,this.models=this.parentView.models},setBoxes:function(){this.addPassengerBox=this.viewPort.find("#addPassenger"),this.passengerInfoBox=this.viewPort.find("#passengerInfo"),this.passengerInfoHeader=this.viewPort.find("#passenger-info-header")},setTemplate:function(){this.viewPort.append(g),this.passengerInfoHeaderFun=_.template(this.viewPort.find("#passenger-info-header-tpl").html()),this.addPassengerTplFun=_.template(this.viewPort.find("#addPassenger_tpl").html()),this.passengerInfofun=_.template(this.viewPort.find("#passengerInfotpl").html())},fireEvents:function(){this.parentView.on(this.parentView.EVENTS.DETAILCOMPLETE,this.flightDetailCalback.bind(this)),this.parentView.on(this.parentView.EVENTS.PASSENGERSCOMPLETE,this.passengersCallback.bind(this))},initialize:function(a){this.changeOpts(a),this.setBoxes(),this.setTemplate(),this.fireEvents(),this.needDelIcon=!0},setHtmlPassengerInfo:function(a){var b=this.passengerInfofun(a);this.passengerInfoBox.empty(),this.passengerInfoBox.html(b),this.addPassengerBox.hide(),this.updatePassengerInfoHeader(),this.addEventListener()},setHtmlAddPassenger:function(a){a.needDelIcon=this.getDelIconFlag(a.passengers||[]),a.selCount=this.stores.passengerQueryStore.getAttr("selCount");var b=this.addPassengerTplFun(a);this.addPassengerBox.empty(),this.addPassengerBox.html(b),this.passengerInfoBox.hide(),this.updatePassengerInfoHeader(),this.addEventListener(),this.onInputLogPass(e),$("li[id|=cname-container]").each(function(){$(this).find(".flight-langswt").length>0&&("none"==$(this).find(".flight-langswt").css("display")?$(this).find(".cui-focus-close").css("right","20px"):$(this).find(".cui-focus-close").css("right","85px"))})},addEventListener:function(){$("#js_addPass_btn").unbind("click").bind("click",this.addPassengerAction.bind(this)),$(".js_del_icon").off("touchend").on("touchend",this.deleteEditPassenger.bind(this)),$("#addPassenger .flight-infoinput-pdl .flight-arrdown").unbind("click").bind("click",$.proxy(this.IdCardListAction,this)),$(".flight-iptetp > span").unbind("click").bind("click",this.selectTicketType.bind(this)),$(".flight-tips-etp2 .close").unbind("click").bind("click",this.closeWithAdultTips),$("#passengerInfo .flight-infodel2").unbind("click").bind("click",$.proxy(this.passengerDelete,this)),$("#passengerInfo .flight-listsim3-table ul").unbind("click").bind("click",this.passengerEdit.bind(this)),$("#js_selectPass_btn").unbind("click").bind("click",this.passengerSelect.bind(this)),$(".js_enName").unbind("keyup").bind("keyup",this.enameLiveChange),$(".flight-langswt > em").unbind("click").bind("click",this.switchLanguageAction.bind(this)),$("#addPassenger > li").unbind("click").bind("click",this.setCurrentEditPsg.bind(this)),$("#addPassenger input").unbind("touchstart").bind("touchstart",function(a){var b=a.changedTouches[0].pageY;$(a.currentTarget).bind("touchend",function(c){Math.abs(b-c.changedTouches[0].pageY)<=20&&($(a.currentTarget).focus(),$(a.currentTarget).unbind("touchend"))})}),$("#addPassenger .js_birth").unbind("click").bind("click",this.selectBirthAction.bind(this))},getDelIconFlag:function(a){var b=_.filter(a,function(a){return 1==a.selected});return 1==b.length&&b[0]&&b[0].defaIdCard&&(this.needDelIcon=1==b[0].defaIdCard.type?!(!b[0].cname&&!b[0].defaIdCard.no):!!(b[0].cname||b[0].firstName||b[0].lastName||b[0].defaIdCard.no||b[0].birth)),this.needDelIcon},flightDetailCalback:function(a,b,c){var d=this.stores.flightDetailsStore.getAttr("items"),e=d[0].policy,f=e.isApplyChild||e.childPolicy,g=e.isApplyChild||e.childPolicy&&e.childPolicy.isApply||e.babyPolicy;if(a=$.extend(!0,a,{policy:e,getAge:DataControl.getAge,generatePriceStr:this.generatePriceStr.bind(this)}),a.supportChild=f,a.supportBaby=g,this.stores.passengerQueryStore.setAttr("firstFlyDate",d[0].basicInfo.dTime),this.stores.passengerQueryStore.setAttr("lastFlyDate",d.length>1?d[1].basicInfo.dTime:d[0].basicInfo.dTime),c.PASSENGERS){{this.stores.passengerQueryStore.get()}DataControl.updatePassengersTicketType(a),a=$.extend(a,{needDelIcon:this.needDelIcon}),c.HASPASSENGER?this.setHtmlPassengerInfo(a):this.setHtmlAddPassenger(a),this.showWithAdultTip(this.stores.passengerQueryStore,a.passengers)}},passengersCallback:function(a,b,c){if(this.stores.userStore.isLogin()){if(c.PASSENGERSFAIL)return void this.passengersResponseFailHandler(a,c);var d=this.models.passengerQueryModel.getResultStore();d.setAttr("UserId",this.parentView.UserID,d.getTag());var e=d.get();this.filterPassengers(e.passengers);var f=_.filter(e.passengers,function(a){return 1==a.selected}).length;this.stores.passengerQueryStore.setAttr("selCount",f),e=this.stores.passengerQueryStore.get(),e.passengers&&e.passengers.length?(this.stores.isBookingEditStore.setAttr("Edit",!1,this.parentView.UserID),a=$.extend(!0,a,e),c.PASSENGERS=!0,c.HASPASSENGER=!0,c.DETAIL&&(DataControl.updatePassengersTicketType(a),this.setHtmlPassengerInfo(a),this.showWithAdultTip(this.stores.passengerQueryStore,a.passengers))):(this.stores.isBookingEditStore.setAttr("Edit",!0,this.parentView.UserID),this.stores.flightOrderStore.setAttr("passengersinfo",[]),this.addPassengerTpl(this.stores.passengerEditStore,this.stores.passengerQueryStore,!0)),this.stores.isBookingEditStore.getAttr("Edit",this.parentView.UserID)?(e=this.stores.passengerQueryStore.get(),a=$.extend(!0,a,e),c.PASSENGERS=!0,c.DETAIL&&(DataControl.updatePassengersTicketType(a),a=$.extend(a,{needDelIcon:this.needDelIcon}),this.setHtmlAddPassenger(a),this.showWithAdultTip(this.stores.passengerQueryStore,a.passengers)),this.showAddBtn()):(this.passengerInfoBox.addClass("mb10"),this.parentView.$el.find("#js_addPass_btn").hide())}else{this.stores.passengerQueryStore.setLifeTime("365D");var e=this.stores.passengerQueryStore.get(),f=0;e&&e.passengers&&(this.filterPassengers(e.passengers),f=_.filter(e.passengers,function(a){return 1==a.selected}).length),this.stores.passengerQueryStore.setAttr("selCount",f),(!e||e.UserId)&&(this.stores.passengerQueryStore.remove(),e=this.stores.passengerQueryStore.get()||{}),e.passengers&&f||(this.addPassengerTpl(this.stores.passengerEditStore,this.stores.passengerQueryStore,!0),e=this.stores.passengerQueryStore.get()),a=$.extend(a,e),c.DETAIL&&(DataControl.updatePassengersTicketType(a),this.setHtmlAddPassenger(a),this.showWithAdultTip(this.stores.passengerQueryStore,a.passengers),this.updatePassengerInfoHeader(this.stores.flightDetailsStore,this.stores.userStore,this.stores.passengerQueryStore)),this.showAddBtn()}},passengersResponseFailHandler:function(a,b){var c=this.stores.passengerQueryStore.get();if(this.stores.isBookingEditStore.setAttr("Edit",!0,this.parentView.UserID),c&&c.passengers&&c.passengers.length){var d=_.filter(c.passengers,function(a){return 1==a.selected}).length;this.stores.passengerQueryStore.setAttr("selCount",d)}else this.stores.passengerQueryStore.setAttr("passengers",[]),this.stores.passengerQueryStore.setAttr("selCount",0),this.addPassengerTpl(this.stores.passengerEditStore,this.stores.passengerQueryStore,!0);c=this.stores.passengerQueryStore.get(),a=$.extend(a,c),b.PASSENGERS=!0,b.DETAIL&&(this.setHtmlAddPassenger(a),this.showWithAdultTip(this.stores.passengerQueryStore,a.passengers),DataControl.passegnersTplData=a),this.showAddBtn()},updatePassengerInfoHeader:function(){var a=this.stores,b=a.flightDetailsStore.getAttr("items"),c=b[0].policy,d=c.isApplyChild||c.childPolicy,e=c.isApplyChild||c.childPolicy&&c.childPolicy.isApply||c.babyPolicy,f=a.userStore.isLogin(),g=(a.passengerQueryStore.getAttr("passengers"),f?!a.isBookingEditStore.getAttr("Edit",this.parentView.UserID):!1),h={ticketsCnt:this.getTicketsCount(a.passengerQueryStore),supportChild:d,supportBaby:e,showSelBtn:g},i=this.passengerInfoHeaderFun;this.passengerInfoHeader.html(i(h)),$("#js_selectPass_btn").unbind("click").bind("click",this.passengerSelect.bind(this))},getTicketsCount:function(a,b){var c=a.getAttr("passengers")||[],d=[0,0,0];return _.each(c,function(a){1==a.selected&&d[a.ticketType-1]++}),b?d[d-1]:d},addPassengerAction:function(){var a=this.stores.flightDetailsStore.getAttr("items"),b=a[0].policy.qty;+this.stores.passengerQueryStore.getAttr("selCount")>=b?this.parentView.showAlert("很抱歉，因票量有限，最多只能添加"+b+"名乘机人",!1):(this.addPassengerTpl(this.stores.passengerEditStore,this.stores.passengerQueryStore,!0,!0),this.parentView.updatePage()),this.stores.mdStore.increaseCntByKey("MorePassengerClick")},deleteEditPassenger:function(a){var b=this.parentView,c=(b.showLoading,parseInt(this.stores.passengerQueryStore.getAttr("selCount"))),d=$(a.currentTarget).data("id"),e=function(){DataControl.deletePsgById(d),b.updatePage()};this.watchIsSpace(d)?c>1?this.deletePsgConfirm(e,d):this.clearPassengerInfo(a,d):c>1&&e()},watchIsSpace:function(a){var b=$("#addPassenger > li[data-id='"+a+"']");return"none"==$("#cname-container-"+a).css("display")?!!(b.find(".js_firstName").val()||b.find(".js_lastName").val()||b.find(".js_no").val()||b.find(".js_birth").val()):!(!b.find(".js_newName").val()&&!b.find(".js_no").val())},deletePsgConfirm:function(b,c){var d=this,e=new a.ui.Alert({title:"提示信息",message:"您确定要删除当前乘机人信息吗？",buttons:[{text:"取消",click:function(){this.hide()}},{text:"确定",click:function(){this.hide(),d.parentView.showLoading();try{var a=d.stores.mdStore.getAttr("passengers");a&&a[c]&&delete a[c],d.stores.mdStore.setAttr("passengers",a)}catch(e){0}b&&b()}}]});e.show()},clearPassengerInfo:function(a,b){{var c=DataControl.getPsgById(b),d=$(a.currentTarget).closest("li[data-id='"+b+"']");c.ticketType}c&&(c.cname="",c.firstName="",c.lastName="",c.birth="",c.defaIdCard.no="",c.empty=!0,c.ticketType=1,d.find(".flight-iptetp").find("span").each(function(a,b){$(b).removeClass("flight-iptetp-current"),0==a?$(b).addClass("flight-iptetp-current"):""}),this.setPassengerById(this.stores.passengerQueryStore,b,c),d.find(".js_newName").val(""),d.find(".js_firstName").val(""),d.find(".js_lastName").val(""),d.find(".js_no").val(""),d.find(".js_birth").val(""),d.find(".flight-iptetp").parent().hide(),d.find(".flight-ipt-etp3").hide(),$("#flightBox .flight .flight-tips-etp2").hide(),d.find(".form-tips").hide(),d.find(".js_del_icon").remove(),d.addClass("flight-psinfo-fstps"),this.parentView.trigger(this.parentView.EVENTS.UPDATEORDERPRICE),this.updatePassengerInfoHeader())},IdCardListAction:function(b){var c=this,d=this.parentView.stores,f=$(b.currentTarget).attr("data-Id"),g=$(b.currentTarget).closest("li[data-id='"+f+"']");DataControl.PassEditData=this.getPassengerById(f,d.passengerQueryStore);for(var h=$("#sel_idCard-"+f+" option"),i=g.find(".js_no"),j=g.find(".js_birth").closest("li"),k=[],l=0,m=DataControl.PassEditData.idcards,n=0,o=h.length;o>n;n++){var p={},q=$(h[n]);q.attr("selected")&&(l=n),p.key=q.val(),p.val=q.html(),p["data-no"]=m[n]?m[n].no:"",p.inforId=f,k.push(p)}var r=$("#sel_idCard-"+f),s=g.find("label.flight-arrdown"),t=new a.ui.ScrollRadioList({title:"选择证件",index:l,data:k,itemClick:function(a){var b=$.trim(g.find(".js_newName").val()),h=g.find(".js_canme-container"),k=g.find(".js_ename-container"),l=g.find("input.js_no").data("type"),m=h.find(".flight-langswt");DataControl.PassEditData=c.getPassengerById(a.inforId,d.passengerQueryStore),"1"===a.key?(j.hide(),DataControl.PassEditData.cname=b.replace(/\s/g,""),i.val(e.formatCardNo(a["data-no"])),h.show(),k.hide(),m.hide(),h.find(".cui-focus-close").css("right","20px"),DataControl.PassEditData.language="CN",c.setPassengerById(d.passengerQueryStore,a.inforId,DataControl.PassEditData)):(j.show(),i.val(a["data-no"]),m.show(),h.find(".cui-focus-close").css("right","85px")),g.find("input.js_no").data("type",a.key);var n=g.find(".flight-iptetp"),o=n.find("span.flight-iptetp-current");if((25==l||27==l)&&a.key!=l&&DataControl.PassEditData.birth&&e.testBirth(DataControl.PassEditData.birth)){var p=DataControl.getAge(DataControl.PassEditData.birth),q=DataControl.getPsgType(p),t=(o.length?parseInt(o.data("type")):-1,c.findLowPriceTicketByPsgType(q));-1!=t?(c.selectTicketType(null,n.find("span:nth-child("+t+")")[0],!0),n.parent().siblings(".flight-ipt-etp3").hide(),c.parentView.hideErrorTips('li[data-id="'+f+' .js_birth"]'),1!=t?n.parent().show():n.parent().hide()):(n.parent().hide(),n.parent().siblings(".flight-ipt-etp3").show())}d.passengerEditStore.setAttr("cname",DataControl.PassEditData.cname),d.passengerEditStore.setAttr("ename",DataControl.PassEditData.ename),r.val(a.key),s.html(a.val.length>4?a.val.substring(0,4):a.val),i.data("index",a.index),i.focus();for(var u=0;u<DataControl.PassEditData.idcards.length;u++)DataControl.PassEditData.idcards[u].choose=!1;DataControl.PassEditData.idcards[a.index].choose=!0,DataControl.PassEditData.defaIdCard=DataControl.PassEditData.idcards[a.index],c.setPassengerById(d.passengerQueryStore,a.inforId,DataControl.PassEditData),"1"==a.key&&e.validateCard(c.parentView.showErrroTips,1,DataControl.PassEditData.defaIdCard,"",!1)?c.idCardFocusOutHandler(i[0]):i.focus(),c.parentView.hideErrorTips('li[data-id="'+f+'"] .form-tips'),c.handleErrorInfo(DataControl.PassEditData.birth)}});t.show()},handleErrorInfo:function(a){var b=this,c=DataControl.getAge(a),d=DataControl.getPsgType(c),f=2==d?"儿童":"婴儿",g=DataControl.PassEditData.inforId;-1==DataControl.PassEditData.ticketType&&(b.parentView.hideErrorTips('li[data-Id="'+g+'"] .js_no'),1!=d&&e.showTip(DataControl.TIPICONS.RED,'li[data-id="'+g+'"] .js_birth',"该价格"+f+"不可订，请选择其他舱位",!1))},idCardFocusOutHandler:function(a){var b=$(a).closest("li[data-Id]").attr("data-Id"),c=$(a).val().replace(/\s/g,""),d=!0;if(DataControl.PassEditData=this.getPassengerById(b,this.stores.passengerQueryStore),this.parentView.$el.find("#sel_idCard-"+b+" option").eq($(a).data("index")).data("no",c),DataControl.PassEditData.idcards[$(a).data("index")].no=c,DataControl.PassEditData.defaIdCard.no=c,this.stores.passengerEditStore.setAttr("idcards",DataControl.PassEditData.idcards),this.stores.passengerEditStore.setAttr("defaIdCard",DataControl.PassEditData.defaIdCard),1==DataControl.PassEditData.defaIdCard.type){var c=$(a).val().replace(/\s/g,"");$(a).val(e.formatCardNo(c))}this.setPassengerById(this.stores.passengerQueryStore,b,DataControl.PassEditData);var f=e.checkPassenger(this.parentView,this.parentView.showErrorTips,DataControl.PassEditData,"defaIdCard",b,d),g="#addPassenger > li[data-Id='"+b+"'] .js_no";f&&1==DataControl.PassEditData.defaIdCard.type&&(this.toggleTicketType(e.getBirth(c),g,null,e),DataControl.PassEditData.birth=e.getBirth(c),this.stores.passengerEditStore.setAttr("birth",DataControl.PassEditData.birth),this.setPassengerById(this.stores.passengerQueryStore,b,DataControl.PassEditData),$("#addPassenger li[data-id='"+b+"'] .js_birth").val(DataControl.PassEditData.birth))},switchLanguageAction:function(a){var b=$(a.currentTarget).data("lan"),c=$(a.currentTarget).closest("li[data-id]"),d=c.data("id"),e=c.find(".js_canme-container"),f=c.find(".js_ename-container"),g=this.getPassengerById(d,this.stores.passengerQueryStore),h=g.defaIdCard&&1==g.defaIdCard.type?!0:!1;h||$(a.currentTarget).hasClass("flight-langswt-selected")||("CN"==b?(e.show(),f.hide()):(e.hide(),f.show())),h?(e.find(".flight-langswt").hide(),e.find(".cui-focus-close").css("right","20px")):(e.find(".flight-langswt").show(),e.find(".cui-focus-close").css("right","85px")),DataControl.PassEditData=this.getPassengerById(d,this.stores.passengerQueryStore),DataControl.PassEditData.language=b,this.setPassengerById(this.stores.passengerQueryStore,d,DataControl.PassEditData)},setCurrentEditPsg:function(a){try{$(a.currentTarget).data("id")?($(a.currentTarget).siblings("li").find(".flight-psinfo-no").removeClass("flight-psinfo-no-current"),$(a.currentTarget).find(".flight-psinfo-no").addClass("flight-psinfo-no-current")):($(a.target).closest("li[data-id]").siblings("li").find(".flight-psinfo-no").removeClass("flight-psinfo-no-current"),$(a.target).closest("li[data-id]").find(".flight-psinfo-no").addClass("flight-psinfo-no-current"))}catch(a){0}},selectTicketType:function(a,b){var c=$(b?b:a.currentTarget),d=this.stores.passengerQueryStore.get()||{},e=d.passengers||[],f=parseInt(c.parent().data("psgidx")),g=parseInt(c.data("type"));if(!c.hasClass("flight-iptetp-current")){c.siblings("span").removeClass("flight-iptetp-current"),e[f].ticketType=g,this.setPassengerById(this.stores.passengerQueryStore,e[f].inforId,e[f]),e[f].edit&&(DataControl.PassEditData.ticketType=e[f].ticketType,this.stores.passengerEditStore.setAttr("ticketType",g)),c.addClass("flight-iptetp-current"),this.showWithAdultTip(this.stores.passengerQueryStore,e),this.updatePassengerInfoHeader(this.stores.flightDetailsStore,this.stores.userStore,this.stores.passengerQueryStore),this.parentView.trigger(this.parentView.EVENTS.UPDATEORDERPRICE);var h=this.stores.flightDetailsStore.get();this.parentView.QueryCustomerCoupon(this.stores.userStore,this.stores.passengerQueryStore,this.stores.flightOrderStore,this.stores.flightDetailsStore,this.models.customerCouponModel,this.parentView,this.couponstplfun,h)}},selectBirthAction:function(a){var b=this,c=$(a.currentTarget),d=c.data("key")+"",g=/^(19[0-9]{2}|20[01]{1}\d{1})(0[1-9]{1}|1[0-2]{1})(0[1-9]{1}|[12]\d{1}|3[01]{1})$/.test(d),h=(c.closest("li[data-id]").data("id"),(new Date).getFullYear()),i=g?+d.substring(0,4)-(h-80):1980-(h-80),j=g?+d.substring(4,6)-1:0,k=g?+d.substring(6,8)-1:0,l=e.getDateItems(),m=function(a){var b=+a.key,c=+o.getItemByIndex(1).key,d=+o.getItemByIndex(2).key,f=e.getDayItem(b,c),g=d<=f.length?d-1:f.length-1;2==c&&o.updateScrollListByIndex(2,f,g)},n=function(a){var b=+o.getItemByIndex(0).key,c=+a.key,d=+o.getItemByIndex(2).key,f=e.getDayItem(b,c),g=d<=f.length?d-1:f.length-1;o.updateScrollListByIndex(2,f,g)},o=new f({title:"选择出生日期",data:l,index:[i,j,k],changed:[m,n,null],disItemNum:4,cancel:"取消",ok:"确定",className:"flight-date-box",okClick:function(d){c.val(d[0].name+d[1].name+d[2].name),c.data("key",d[0].key+d[1].key+d[2].key),b.finishBirthAction(a)}.bind(this)});o.show()},closeWithAdultTips:function(){$(".flight-tips-etp2").addClass("close_animate"),document.querySelector(".flight-tips-etp2").addEventListener("webkitAnimationEnd",function(){$(".close_animate").hide()},!1)},passengerDelete:function(b){var c=this,d=this.parentView.stores,e=d.passengerQueryStore.get(),f=$(b.currentTarget),g=f.attr("data-id"),h=f.attr("data-index");if(!g||!e||!h||0>+h)return void this.parentView.showAlert();var i=($.grep(e.passengers,function(a){return"1"==a.selected}),new a.ui.Alert({title:"提示信息",message:"您确定要删除该乘机人吗？",buttons:[{text:"取消",click:function(){this.hide()}},{text:"确定",click:function(){this.hide(),c.parentView.showLoading();try{var a=d.mdStore.getAttr("passengers");a[g]&&delete a[g],d.mdStore.setAttr("passengers",a)}catch(b){}var f=e.passengers[h];f&&f.inforId==g&&(f.selected=0,e.selCount-=1),DataControl.updatePassengersTicketType(e);var i=d.passengerQueryStore.getTag();DataControl.updatePassengersTicketType(e),d.passengerQueryStore.set(e,i),c.parentView.updatePage(function(){c.parentView.hideLoading()})}}]}));i.show()},passengerEdit:function(a){var b=this.stores,c=$(a.currentTarget),d=c.data("id"),e=c.attr("data-index");if(!d||0>=+d)return void this.parentView.showToast("请选择您要修改的乘机人。");var f=b.passengerQueryStore.get();if(!f||!f.passengers||+f.selCount<=0)return void this.parentView.showToast("请选择您要修改的乘机人。");this.parentView.showLoading();var g=f.passengers[e],h=b.passengerEditStore.getTag(),i=b.flightDetailsStore.getAttr("items")[0].policy;b.passengerEditStore.set(g,h),b.passengerEditStore.setAttr("backurl",null),b.passengerEditStore.setAttr("opr",4),b.passPageTypeStore.setAttr("type",1),b.passPageTypeStore.setAttr("passengerType",DataControl.getPsgType(null,g)),b.passPageTypeStore.setAttr("hasChildTicket",!!i.childPolicy),b.passPageTypeStore.setAttr("hasBabyTicket",!!i.babyPolicy),b.passPageTypeStore.setAttr("babyCanBuyChildTicket",!(!i.childPolicy||!i.childPolicy.isApply)),g.ticketType=-1,b.passengerEditStore.setAttr("ticketType",-1),this.setPassengerById(b.passengerQueryStore,g.inforId,g);var j=b.flightDetailsStore.getAttr("items");b.passPageTypeStore.setAttr("firstFlyDate",j.length>1?j[1].basicInfo.dTime:j[0].basicInfo.dTime),this.parentView.jump("/webapp/fpage/index.html#passengerEdit!"+$(a.currentTarget).attr("data-id"))},passengerSelect:function(a){var b=this.stores,c=b.flightDetailsStore.get();if(!c)return void this.parentView.showAlert();b.passPageTypeStore.setAttr("type",1),b.passPageTypeStore.setAttr("passengerType",1);var d=b.flightDetailsStore.getAttr("items");b.passPageTypeStore.setAttr("firstFlyDate",d.length>1?d[1].basicInfo.dTime:d[0].basicInfo.dTime),this.parentView.$el.find(".js_newName").off("focusout"),this.parentView.jump("/webapp/fpage/#passengerSelect!"+$(a.currentTarget).attr("data-id"))},findLowPriceTicketByPsgType:function(a){var b=this.parentView.stores,c=b.flightDetailsStore.getAttr("items"),d=c[0].policy,e=1,f=2,g=3,h=DataControl.getTicketAmtByType(e),i=DataControl.getTicketAmtByType(f),j=DataControl.getTicketAmtByType(g);return a==f?d.childPolicy?h>i?f:d.isApplyChild?e:f:d.isApplyChild?e:-1:a==g?d.babyPolicy?d.isApplyChild?d.childPolicy&&d.childPolicy.isApply?h>j?j>i?f:g:h>i?f:e:h>j?g:e:d.childPolicy&&d.childPolicy.isApply?i>j?g:f:g:d.isApplyChild?d.childPolicy&&d.childPolicy.isApply&&h>i?f:e:d.childPolicy&&d.childPolicy.isApply?f:-1:e},generatePriceStr:function(a){var b=this.stores.flightDetailsStore.getAttr("items"),c=0,d=0,e=0;return b.forEach(function(b){a?(c+=b.policy[a]?b.policy[a].price:0,d+=b.policy[a]?b.policy[a].tax:0,e+=b.policy[a]?b.policy[a].fuelCost:0):(c+=b.policy.price,d+=b.policy.tax,e+=b.policy.fuelCost)}),"¥"+(c+d+e)},showAddBtn:function(){var a=this.parentView.stores,b=a.passengerQueryStore.get();b&&b.selCount>=9?($("#js_addPass_btn").hasClass("js_hide")||$("#js_addPass_btn").addClass("js_hide"),$("#WaringMessage").hasClass("js_hide")&&$("#WaringMessage").removeClass("js_hide")):($("#js_addPass_btn").hasClass("js_hide")&&$("#js_addPass_btn").removeClass("js_hide"),$("#WaringMessage").hasClass("js_hide")||$("#WaringMessage").addClass("js_hide"))},showWithAdultTip:function(a,b){b=b||a.get().passengers,this.hasAdultWith(b)?$(".flight-tips-etp2").hide():$(".flight-tips-etp2").show().removeClass("close_animate")},hasAdultWith:function(a){var b=!1,c=!1,d={ADULT:1,CHILD:2,BABY:3,NEWBORN:4};return a=a||[],$(a).each(function(a,e){if(1==e.selected){if(e.ticketType==d.ADULT)return b=!0,!1;(e.ticketType==d.CHILD||e.ticketType==d.BABY)&&(c=!0)}}),b||!c},isNull:function(a){return"object"==typeof a&&void 0==a},hasChildrenOrBaby:function(){var a=this.stores.flightDetailsStore.get(),b=!1,c=this;return $(a.items).each(function(a,d){var e=d.policy.babyPolicy,f=d.policy.childPolicy;c.isNull(e)&&c.isNull(f)&&(b=!0)}),b},beforePayValidate:function(){var a=this,b=this.stores,c=b.passengerQueryStore.get(),d=!(b.userStore.isLogin()&&!b.isBookingEditStore.getAttr("Edit",this.parentView.UserID)),f=[],g=[],i=0,j=h.ADULT,k={1:0,2:0,3:0},l=b.flightDetailsStore.getAttr("items")||[],m=0,n=!0,o=c.passengers||[];return $.each(o,function(b,c){if(g=[],1==+c.selected){i+=1;var h=d?e.checkPassenger(a.parentView,a.parentView.showErrorTips,c,"cname",c.inforId,n):!0;if(h||g.push({className:DataControl.errorType,errorMessage:DataControl.errorMessage}),h=d?e.checkPassenger(a.parentView,a.parentView.showErrorTips,c,"defaIdCard",c.inforId,n):!0,h||g.push({className:DataControl.errorType,errorMessage:DataControl.errorMessage}),1!=+c.defaIdCard.type)h=d?e.checkPassenger(a.parentView,a.parentView.showErrorTips,c,"defaIdCard",c.inforId,n):!0,h||g.push({className:DataControl.errorType,errorMessage:DataControl.errorMessage}),h=d?e.checkPassenger(a.parentView,a.parentView.showErrorTips,c,"birth",c.inforId,n):!0,h||g.push({className:DataControl.errorType,errorMessage:DataControl.errorMessage}),h&&(m=DataControl.getAge(c.birth),25==c.defaIdCard.type&&m>=16&&(DataControl.errorType=".js_birth",DataControl.errorMessage="年龄已满16周岁，不能使用户口簿",g.push({className:DataControl.errorType,errorMessage:DataControl.errorMessage}),h=!1),27==c.defaIdCard.type&&m>=12&&(DataControl.errorType=".js_birth",DataControl.errorMessage="年龄已满12周岁，不能使用出生证明",g.push({className:DataControl.errorType,errorMessage:DataControl.errorMessage}),h=!1),l.length>1&&!a.validateSecondFlyTicketType(c,g)&&(h=!1),a.validateAllowChildBuy(c,g)||(h=!1),h&&(j=c.ticketType>0?c.ticketType:1,k[j]++));else{var h=d?e.checkPassenger(a.parentView,a.parentView.showErrorTips,c,"defaIdCard",c.inforId,n):!0;h?(l.length>1&&!a.validateSecondFlyTicketType(c,g)&&(h=!1),a.validateAllowChildBuy(c,g)||(h=!1),h&&(j=c.ticketType>0?c.ticketType:1,k[j]++)):g.push({className:DataControl.errorType,errorMessage:DataControl.errorMessage})}}g.length&&f.push({errorInforId:c.inforId,errorInfo:g})}),f.length?($.each(f,function(b,c){$.each(c.errorInfo,function(b,d){a.parentView.showErrorTips(d.className,d.errorMessage,c.errorInforId,!1)})}),!a.stores.userStore.isLogin()||a.stores.userStore.isLogin()&&a.stores.isBookingEditStore.getAttr("Edit",a.parentView.UserID)?a.parentView.showErrorTips(f[0].errorInfo[0].className,f[0].errorInfo[0].errorMessage,f[0].errorInforId,!0):e.showTip(DataControl.tipIconType||DataControl.TIPICONS.RED,'li[data-id="'+f[0].errorInforId+'"] .flight-listsim3-table',f[0].errorInfo[0].errorMessage,!0),!1):0>=i?(a.parentView.showAlert("请选择乘机人",!1),!1):k[h.CHILD]&&k[h.BABY]?(a.parentView.showAlert("儿童票和婴儿票请分2张订单提交",!1),!1):k[h.BABY]>k[h.ADULT]?(a.parentView.showAlert("一位成人只能带一位婴儿，请继续添加成人乘客",!1),!1):i>9?(a.parentView.showAlert("最多选择9位乘机人",!1),void a.stores.mdStore.increaseCntByKey("NextStepNotPassClick")):!0},validateSecondFlyTicketType:function(a){var b=1!=a.defaIdCard.type?a.birth:e.getBirth(a.defaIdCard.no),c=DataControl.getPsgType(DataControl.getAge(b));if(c!==h.ADULT&&a.ticketType&&1!==a.ticketType&&c!==DataControl.getPsgType(DataControl.getAge(b,!1))){if(c===h.CHILD&&2===a.ticketType)return that.parentView.showAlert("【"+(a.cname||a.ename)+"】第二程起飞当日已满12岁，不能购买儿童票。如仍需购买儿童票，两程须分开预订，或可拨打携程客服电话预订400-008-6666。",!1),!1;if(c===h.BABY&&3===a.ticketType)return this.parentView.showAlert("【"+(a.cname||a.ename)+"】第二程起飞当日已满2岁，不能许购买婴儿票。如仍需购买婴儿票，两程须分开预订，或可拨打携程客服电话预订400-008-6666。",!1),!1}return!0},validateAllowChildBuy:function(a,b){var c=this.stores,d=1,f=1!=a.defaIdCard.type?a.birth:e.getBirth(a.defaIdCard.no);if(f&&(d=DataControl.getPsgType(DataControl.getAge(f))),d===h.CHILD||d===h.BABY){var g=c.flightDetailsStore.getAttr("items"),i=a.ticketType?a.ticketType:1,j=g[0].policy.isApplyChild,k=!!g[0].policy.childPolicy,l=!!g[0].policy.babyPolicy,m=!1;if(1===i?m=!j:2===i?m=d===h.CHILD?!k:!k||k&&!g[0].policy.childPolicy.isApply:3===i?m=d===h.CHILD||d===h.BABY&&!l:-1==i&&(m=!0),m)return DataControl.errorType=1==a.defaIdCard.type?".js_no":".js_birth",DataControl.errorMessage="该价格"+(d===h.CHILD?"儿童":"婴儿")+"不可订，请选择其他舱位",b.push({className:DataControl.errorType,errorMessage:DataControl.errorMessage}),!1}return!0},checkSupportCards:function(a,b,c){var d=function(a,b){var c=[];return a.forEach(function(a){b.forEach(function(b){a==b&&c.push(b)})}),c},e=[],f=[],g=[],h=[],i=["1","2","8","7","4","10","21","20","11","99"],j=[],k=c.idCardsDict();if(a.get()&&a.get().items&&(e=a.get().items),b.get()&&b.get().passengers&&(f=b.get().passengers),e.forEach(function(a){""!=a.policy.cardTypes&&g.push(a.policy.cardTypes.split(","))}),g.length>0){if(h=g[0],g.forEach(function(a){h=d(h,a)}),0==h.length)return this.parentView.showAlert("证件不符合航班需求，请重新选择航班",!1),!1;for(var l in h)for(var m in k)k[m].type.toString()==h[l]&&j.push(k[m].name);h.forEach(function(a){for(var b=0;b<i.length;b++)i[b]==a&&(i.splice(b,1),b--)});for(var n in f){var o=f[n];if(1==+o.selected){var p=o.defaIdCard.type;for(var q in i)if(p==i[q])return this.parentView.showAlert("您选择的航班只能使用"+j.join(",")+"进行预订，请修改乘机人的证件",!1),!1}}return!0}return!0},checkMinPassenger:function(a,b){var c=[],d=[],e=0,f=0;if(a.get()&&a.get().items&&(d=a.get().items),b.get()&&b.get().passengers&&(c=b.get().passengers),0==d.length)return this.parentView.showAlert(),!1;e=d.reduce(function(a,b){var c=b.policy.minNum;return c>a?c:a},d[0].policy.minNum);for(var g in c){var h=c[g];1==+h.selected&&f++}this.parentView.$el.find("#paybtn em.fs").data("amt");return f>=e?!0:(this.parentView.showAlert("本航班至少需要选择"+e+"位成人票乘客才能下单，您也可以选择其他舱位预订",!1),!1)},savePassengers:function(){var b=0,c=0,d=[],f=this.stores.passengerQueryStore.get(),g=this.models.passengerEditModel,h=this.stores.flightOrderStore.getAttr("passengersinfo")||[];for(var i in f.passengers){var j=f.passengers[i];if(1==+j.selected){var k=null;if(b++,c+=1==j.ticketType?1:0,k=1==+j.defaIdCard.type?a.base.Date.parse(e.getBirth(j.defaIdCard.no)).format("Y-m-d"):a.base.Date.parse(j.birth).format("Y-m-d"),h&&!this.hasExistPassenger(h,j)){if(this.stores.userStore.isLogin()){var l=$.extend({},j);l.birth=k,this.stores.isBookingEditStore.getAttr("Edit",this.parentView.UserID)&&(g.setParam("opr",l.opr),g.setParam("birth",l.birth),g.setParam("biztype",l.biztype),g.setParam("cname",l.cname),g.setParam("email",l.email),g.setParam("ename",l.ename||l.firstName+"/"+l.lastName),g.setParam("flag",l.flag),g.setParam("gender",l.gender),g.setParam("idcards",l.idcards),g.setParam("mphone",l.mphone),g.setParam("fmphone",l.fmphone),g.setParam("natl",l.natl),g.setParam("ver",l.ver),g.setParam("defaIdCard",l.defaIdCard),g.setParam("natlName",l.natlName),g.setParam("flightType",l.flightType),g.excute(function(a){l.inforId=a.inforId,h.push(l)},function(a){0},!0,this))}d.push({id:j.inforId,name:this.getCardName(j),birth:k,passportNo:j.defaIdCard.no,passportType:j.defaIdCard.type,phone:j.mphone?j.mphone:"",gender:j.gender,natl:j.natl})}}}return{pcount:b,adultTicketCnt:c,passengers:d}},getCardName:function(a){return 1==a.defaIdCard.type?a.cname:"CN"==a.language?a.cname:a.ename||a.firstName+"/"+a.lastName},hasExistPassenger:function(a,b){var c=!1;return $.each(a,function(a,d){return d.inforId==b.inforId?(c=!0,!1):void 0}),c}});return i=a.base.implement(i,d)});