define(["libs","c","FlightModel","FlightStore","cMultipleDate",buildViewTemplatesPath("flightlistfilter.html")],function(a,b,c,d,e,f){var g=(b.ui,b.utility),h=b.view.extend({pageid:"212008",tpl:f,flightSearchSubjoin:d.FlightSearchSubjoinStore.getInstance(),flightList:c.FlightListModel.getInstance(),flightSearchStore:d.FlightSearchStore.getInstance(),flightFilterStore:d.FlightFilterStore.getInstance(),flightTakeOfTimeStore:d.FlightTakeOfTimeStore.getInstance(),flightCabinStore:d.FlightCabinStore.getInstance(),lastcuritem:null,curitem:null,tripType:1,baseDataModel:null,cacheDepartFilterType:null,cacheArriveFilterType:null,basedata:null,menus:["起飞时段","舱位选择","航空公司"],render:function(){this.viewdata.req=this.request,this.$el.html(this.tpl),this.buildhtml=_.template(this.tpl)},buildElement:function(){this.els={elmenus:this.$el.find("#menus"),elmenusli:this.$el.find("#menus li"),elitems:this.$el.find("#itemsbox ul"),elitemtpl:this.$el.find("#itemstpl"),elitemtpl2:this.$el.find("#itemstpl2"),elmenutpl:this.$el.find("#menutpl")}},events:{"click #js_return":"backAction","click #menus li":"tapMenusAction","click #itemsbox li":"tapItemAction"},tapItemAction:function(a){var b=$(a.currentTarget),c=b.attr("data-type"),d=b.attr("data-value");this.lastcuritem=b.siblings(".choosed"),this.curitem=b,b.siblings().removeClass("choosed"),b.addClass("choosed"),this.showLoading(),this.checkExistData(c,d,function(){tripType=this.flightSearchStore.getAttr("__tripType"),this.back(2==tripType?"backlist":"list"),this.hideLoading()},function(){this.back("list"),this.hideLoading()})},checkExistData:function(a,b,c,d){this.showLoading(),this.flightList.excute(function(d){0,0,0;var e=d.items;switch(0,a){case"0":if(!(b.indexOf("-")>0))return this.clearCurFilter(),this.hideLoading(),void c.call(this);var f=b.split("-"),g=parseInt(f[0].replace(":","")),h=parseInt(f[1].replace(":","")),i=/^\d{4}[-\/]\d{1,2}[-\/]\d{1,2}\s+(\d{1,2}:\d{1,2}):\d{1,2}$/i;e=_.filter(e,function(a){var b=i.exec(a.dTime);b=b&&b[1];var c=parseInt(b.replace(":",""));return c>=g&&h>=c});break;case"1":if(!b.length){switch(this.tripType){case 1:this.flightSearchSubjoin.removeAttr("departfilter-type-cabin");break;case 2:this.flightSearchSubjoin.removeAttr("arrivefilter-type-cabin")}return this.clearCurFilter(),this.hideLoading(),void c.call(this)}switch(this.tripType){case 1:this.flightSearchSubjoin.setAttr("departfilter-type-cabin",b);break;case 2:this.flightSearchSubjoin.setAttr("arrivefilter-type-cabin",b)}var j=b;e=$.grep(e,function(a){return a.cabins=$.grep(a.cabins,function(a){return 3==j?5===a.classForDisp||3==a["class"]||4===a.classForDisp||2==a["class"]:0==j?6===a.classForDisp||2!=a["class"]&&3!=a["class"]:!1}),a.cabins&&a.cabins.length>0});break;case"2":if(!b.length)return this.clearCurFilter(),this.hideLoading(),void c.call(this);e=_.filter(e,function(a){return b===a.airlineCode})}if(e&&e.length){switch(this.tripType){case 1:this.flightSearchSubjoin.setAttr("departfilter-type",this.cacheDepartFilterType);break;case 2:this.flightSearchSubjoin.setAttr("arrivefilter-type",this.cacheArriveFilterType)}this.setCurFilter(a,b),this.hideLoading(),c.call(this)}else this.hideLoading(),this.curitem&&this.curitem.removeClass("choosed"),this.lastcuritem&&this.lastcuritem.addClass("choosed"),this.showToast("很抱歉，未查询到您指定的航班记录，请仔细检查重新输入",1)},function(){this.showToast("数据请求失败",1,$.proxy(function(){this.hideLoading(),this.curitem&&this.curitem.removeClass("choosed"),this.lastcuritem&&this.lastcuritem.addClass("choosed"),d&&d.call(this)},this))},!1,this)},clearCurFilter:function(){switch(this.tripType){case 1:this.flightSearchSubjoin.removeAttr("departfilter-type"),this.flightSearchSubjoin.removeAttr("departfilter-value"),this.flightSearchSubjoin.removeAttr("departfilter-type"),this.flightSearchSubjoin.removeAttr("departfilter-value");break;case 2:this.flightSearchSubjoin.removeAttr("arrivefilter-type"),this.flightSearchSubjoin.removeAttr("arrivefilter-value"),this.flightSearchSubjoin.removeAttr("arrivefilter-type"),this.flightSearchSubjoin.removeAttr("arrivefilter-value")}},setCurFilter:function(a,b){switch(this.tripType){case 1:this.flightSearchSubjoin.setAttr("departfilter-type",a),this.flightSearchSubjoin.setAttr("departfilter-value",b),this.flightSearchSubjoin.setAttr("departfilter-type",a),this.flightSearchSubjoin.setAttr("departfilter-value",b);break;case 2:this.flightSearchSubjoin.setAttr("arrivefilter-type",a),this.flightSearchSubjoin.setAttr("arrivefilter-value",b),this.flightSearchSubjoin.setAttr("arrivefilter-type",a),this.flightSearchSubjoin.setAttr("arrivefilter-value",b)}},tapMenusAction:function(a){var b=$(a.currentTarget),c=b.attr("data-type");switch(this.tripType){case 1:this.cacheDepartFilterType=b.attr("data-type");break;case 2:this.cacheArriveFilterType=b.attr("data-type")}this.els.elmenusli.removeClass("hover"),b.addClass("hover"),this.els.elitems.hide(),this.els.elitems.filter("[data-type='"+c+"']").show()},backAction:function(){switch(this.tripType){case 1:this.back("list");break;case 2:this.back("backlist")}},buildEvent:function(){},updatePage:function(a){this.ReDrawView(),a.call(this)},ReDrawView:function(){var a=0,b=0;switch(this.tripType){case 1:a=this.flightSearchSubjoin.getAttr("departfilter-type")||0,b=this.flightSearchSubjoin.getAttr("departfilter-value")||0;break;case 2:a=this.flightSearchSubjoin.getAttr("arrivefilter-type")||0,b=this.flightSearchSubjoin.getAttr("arrivefilter-value")||0}var c={menus:this.menus,flightTakeOfTime:this.flightTakeOfTimeStore.get(),flightCabin:this.flightCabinStore.get(),FlightAirline:this.basedata.FlightAirline,filtermenuIndex:a,filterselected:b};this.$el.html(this.buildhtml(c)),this.buildElement(),this.els.elitems.filter("[data-type='"+a+"']").css("display","block")},onCreate:function(){this.baseDataModel=new e({models:{FlightAirline:c.FlightAirlineModel.getInstance()}}),this.render(),this.buildEvent()},onLoad:function(){this.tripType=this.flightSearchStore.getAttr("__tripType"),"1"==this.tripType?this.pageid="212008":"2"==this.tripType&&(this.pageid="212010"),this.showLoading(),this.baseDataModel.excute(function(a){this.basedata=a,this.basedata.FlightAirline=g.grep(this.basedata.FlightAirline,function(a){return 0===a.countryId},!0).sort(function(a,b){return a.hotFlag-b.hotFlag}),this.updatePage(function(){this.turning(),this.hideLoading()})},function(){},!1,this)},onShow:function(){this.setTitle("筛选")},onHide:function(){this.hideLoading()}});return h});