define(["cSales","libs","c","CommonStore","FlightStore","FlightModel","cBasePageView",buildViewTemplatesPath("flightordermodify.html"),"cUtility","cHolidayCalendar","cWidgetFactory","cWidgetGuider","cWidgetCalendar"],function(a,b,c,d,e,f,g,h,j,k,l){var m=(c.ui,c.base),n=d.SalesObjectStore.getInstance(),o=e.FlightOrderParamStore.getInstance(),p=f.FlightTicketRefundChangeModel.getInstance(),q=e.FlightTicketRefundChangeStore.getInstance(),r=e.FlightTicketChangeForm.getInstance(),s=f.FlightTicketChangeModel.getInstance(),t=d.UserStore.getInstance(),u=t.getUser(),v={},w=(l.create("Calendar"),g.extend({pageid:"214396",tpl:h,calendar:null,viewData:{},passengerList:{},changeTime:{},getAppUrl:function(){var a="";if(t&&t.getUser()){var b="";if(window.localStorage&&null!=window.localStorage.getItem("SALES")&&""!=window.localStorage.getItem("SALES")){var c=JSON.parse(window.localStorage.getItem("SALES"));null!=c.data&&(b=c.data.sourceid)}var d=o.get().Id;a="/flight_inland_change?c1="+d+"&UserID="+t.getUser().LoginName+"&extendSourceID="+b}return a},formData:{extens:"0",flag:0,oid:void 0,tktchgs:[],tktcontinfo:{comment:"",confirm:0,name:"",phone:""}},hasAd:!0,homeUrl:"/html5",backUrl:"flightorderdetail",render:function(){this.$el.html(this.tpl),this.elsBox={flightordermodify_tpl:this.$el.find("#flightordermodify_tpl"),flightordermodify_box:this.$el.find("#flightordermodify_box")},this.flightordermodify_fun=_.template(this.elsBox.flightordermodify_tpl.html())},renderData:function(a){var b=this;a.cDate=m.Date,a.ticketdaytimeshow=this.isShowDaytime(),a.num2Chnum=y;var c=r.get();c&&c.passengerList&&c.changeTime&&(this.passengerList=c.passengerList,this.changeTime=c.changeTime),a.selectp=c;var d=b.flightordermodify_fun(a);b.elsBox.flightordermodify_box.html(d),b.autoSelectPassenger(a)},backAction:function(){if(u=t.getUser(),this.passengerList={},this.flighticketchangermk=null,this.changeTime={},u&&u.Auth)this.back("flightorderdetail");else{var a=n.get();a&&a.sid&&1896==+a.sid?window.location="map://leftClick()":this.jump(this.homeUrl)}},events:{"click .list_st_border .changeplist":"selectPassengers","click .list_st_border .js_departDate":"departDateAction","click #js_psgslist li.js_psgs":"selectPassengerList","click .ticketdaytime":"ticketDaytime","click #ticketchangesumbit":"ticketChangeSumbit"},selectPassengers:function(a){var b=$(a.target).attr("data-index");this.forward("flightordermodifyselect?pindex="+b)},selectPassengerList:function(a){var b=$(a.currentTarget);b.hasClass("checkbox_b_checked")?b.removeClass("checkbox_b_checked"):b.addClass("checkbox_b_checked");var c;c=b.data("index"),this.changePassengerList(0,c,b.hasClass("checkbox_b_checked"))},changePassengerList:function(a,b,c){var d=q.get(),e=d.segs[a].psgs[b];c?(this.passengerList[a]=this.passengerList[a]||{},this.passengerList[a][b]={chgseg:{segid:d.segs[a].segid,psgname:e.name}}):delete this.passengerList[a][b]},ticketDaytime:function(a){var b=$(a.currentTarget);b.hasClass("checkbox_bs_checked")?b.removeClass("checkbox_bs_checked"):b.addClass("checkbox_bs_checked"),this.formData.tktcontinfo.confirm=b.hasClass("checkbox_bs_checked")?1|this.formData.tktcontinfo.confirm:1^this.formData.tktcontinfo.confirm},isShowDaytime:function(){var a=this.getServerDate(),b=a.getHours();return b>21||8>b?!0:!1},userInfoCheck:function(a){var b=this;u=t.getUser();o.get();u&&u.Auth?a.call(b):j.isInApp()?b.showWarning404(function(){location.reload()}):b.jump("/webapp/myctrip/#account/login?from="+encodeURIComponent(this.getRoot()+"#flightorderdetail"))},autoSelectPassenger:function(a){if(1!==a.tktinfo.triptype)return!1;for(var b=0,c=0;c<a.segs[0].psgs.length;c++)2==a.segs[0].psgs[c].uiflag&&(b+=1);if(1==b){var d=this.$el.find("#js_psgslist li.js_psgs").not(".flt_discheck");d.trigger("click")}},checkSumbitData:function(){var a=this,b=!1,c=this.viewData;a.formData.tktchgs=[],a.formData.tktcontinfo.name=c.tktinfo.name,a.formData.tktcontinfo.phone=c.tktinfo.phone;var d=a.passengerList;a.$el.find(".js_departDate").removeClass("cui-input-error"),a.$el.find("#js_psgslist li").removeClass("cui-input-error"),a.$el.find(".changeplist").removeClass("cui-input-error");for(var e in d)for(var f in d[e]){if(b=!0,!a.changeTime[e]){a.hideLoading(),a.$el.find(".js_departDate").addClass("cui-input-error");var g="请选择起飞日期";return a.showToast(g),!1}d[e][f].chgseg.takedate=m.Date.format(a.changeTime[e].takedate,"Y/m/d 0:00:00"),a.formData.tktchgs.push(d[e][f])}if(b)return!0;a.hideLoading(),a.$el.find(".changeplist").addClass("cui-input-error"),a.$el.find("#js_psgslist li").not(".flt_greytit,.flt_discheck").addClass("cui-input-error");var g="请至少选择一个登机人";return a.showToast(g),!1},ticketChangeSumbit:function(a){this.userInfoCheck(function(){var b=($(a.currentTarget),this),c=this.formData;b.showLoading();var d=q.get();u=t.getUser();var e=o.get();if(e&&e.Id){if(r.setAttr("oid",e.Id),null!=e.url&&(b.backUrl=e.url),c.oid=~~e.Id,c.tktcontinfo.comment=this.elsBox.flightordermodify_box.find("#flighticketchangermk").val(),this.checkSumbitData()){if(d&&1==d.tktinfo.triptype&&d.segs.length>1){var f=[];for(var g in d.segs)for(var h in c.tktchgs)f.push({chgseg:{psgname:c.tktchgs[h].chgseg.psgname,segid:d.segs[g].segid,takedate:c.tktchgs[h].chgseg.takedate}});c.tktchgs=f}s.setParam(c),s.excute(function(){b.hideLoading(),this.forward("flightticketchangesucces")},function(a){b.hideLoading();var c=a.msg;b.showToast(c)},!0,this,function(){b.hideLoading(),b.showWarning404(function(){location.reload()})})}}else b.hideLoading(),b.showWarning404(function(){location.reload()})})},onCreate:function(){this.injectHeaderView(),this.render()},onShow:function(){this.setTitle("改签申请"),this.headerview.show()},onLoad:function(){var a=this,b=!0,c=n.get();if(c&&c.sid&&(1575==+c.sid||1867==+c.sid)&&(b=!1),a.headerview.set({title:"改签申请",back:!0,view:a,tel:{number:4000086666},home:b,events:{homeHandler:function(){var b=n.get();b&&b.sid&&1896==+b.sid?window.location="map://leftClick()":a.jump(a.homeUrl)},returnHandler:function(){a.backAction()}}}),a.headerview.show(),u=t.getUser(),u&&u.Auth){this.request.query.oid&&o.setAttr({Id:this.request.query.oid,url:"flight_order_list"});var d=o.get();d&&d.Id?(p.setParam("flag",0),p.setParam("reqtype",2),p.setParam("oid",d.Id),null!=d.url&&(a.backUrl=d.url),a.getFlightTicketRefundChangeSearch()):this.jump("/webapp/myctrip/index.html#orders/flightorderlist")}else j.isInApp()?a.showWarning404(function(){location.reload()}):a.jump("/webapp/myctrip/#account/login?from="+encodeURIComponent(this.getRoot()+"#flightorderdetail"));this.getSalesObj()},getSalesObj:function(){var b=this,c=b.getQuery("sales"),e=b.getQuery("sourceid"),f=d.SalesStore.getInstance().get();null!=f&&null==e&&null==c&&(e=f.sourceid),(c||e)&&a.getSalesObject(c||e,$.proxy(function(){a.replaceContent(b.$el)},this))},onHide:function(){p.abort(),this.elsBox.flightordermodify_box.empty(),this.hideLoading(),this.hideWarning404()},checkData:function(a){try{if(a.tktinfo&&a.tktinfo.expired&&a.segs){if(a.segs.length>0){for(var b in a.segs){a.segs[b].canChange=!1;for(var c in a.segs[b].psgs)2==(2&a.segs[b].psgs[c].uiflag)&&(a.segs[b].canChange=!0)}return!0}return!1}}catch(d){return this.hideLoading(),this.showToast(d.message),!1}},getFlightTicketRefundChangeSearch:function(){var a=this;a.showLoading(),p.excute(function(b){a.headerview.show(),b=x(b,v),q.remove(),q.setAttr(b),null!=b&&null!=b.head&&0==b.head.errcode&&a.checkData(b)?(a.hideLoading(),a.turning(),a.viewData=b,a.createCalendar(new Date(b.tktinfo.expired.replace(/-/g,"/"))),a.renderData(b)):(a.hideLoading(),a.showWarning404(function(){location.reload()}))},function(){a.hideLoading(),a.showWarning404(function(){location.reload()})},!0,this,function(){a.hideLoading(),a.showWarning404(function(){location.reload()})})},createCalendar:function(a){var b=this.getServerDate(),c=this,d=m.Date.diffMonth(b,a);d=d>0?d+1:1,0,this.calendar=new k({monthsNum:d,animatSwitch:"right",header:{title:"日期选择"},endTime:a,callback:function(){c.setPanelDate.apply(c,arguments),this._hide?this._hide():this.hide()},onShow:function(){$("#headerview header").css("z-index",99)},onHide:function(){c.$el.show(),$("#headerview header").css("z-index",9999)}})},departDateAction:function(){this.flighticketchangermk=this.$el.find("#flighticketchangermk").val(),this.calendar.show()},setPanelDate:function(a){var b=this.elsBox.flightordermodify_box.find(".js_departDate .flt_rlink");b.addClass("flt_rshow"),b.html(m.Date.format(a,"Y-m-d")),this.addDateTime(0,a)},addDateTime:function(a,b){this.changeTime[a]=this.changeTime[a]||{},this.changeTime[a].takedate=m.Date.format(b,"Y/m/d 0:00:00")}})),x=function(a,b){for(var c in a)"undefined"==typeof a[c]||null==a[c]?a[c]=b[c]:"object"==typeof a[c]&&(b[c]=b[c]||{},x(a[c],b[c]));return a},y=function(a){var b=a+"",c=b.split(""),d="",e=["","十","百","千","万"],f=["o","一","二","三","四","五","六","七","八","九"],g=c.length;for(i=1;g>=i;i++)d=0==~~c[g-i]?f[~~c[g-i]]+d:f[~~c[g-i]]+e[i-1]+d;return d=d.replace(/(.)\1+/,"$1"),d=d.replace(/o$/,""),"一十"==d&&(d="十"),d.replace("o","零")};return w});