define(["libs","c","CommonStore","fpage/widget/selectSeat/initSeat","FlightStore","FlightModel","cBasePageView",buildViewTemplatesPath("selectseat.html")],function(a,b,c,d,e,f,g,h){var i,j,k,l=f.SelectSeatModel.getInstance(),m=f.SubmitCheckinModel.getInstance(),n=(e.FlightSelectSeatStore.getInstance(),e.FlightSubmitCheckinStore.getInstance(),e.CheckinParamStore.getInstance(),e.CheckPassengerStore.getInstance()),o=c.UserStore.getInstance(),p=g.extend({render:function(){var a={title:n.getAttr("depname")+"-"+n.getAttr("arrname"),caption:n.getAttr("airname")+n.getAttr("fno"),cfply:n.getAttr("cfply")},b=this.$el.find("#selectSeatHeader").html(),c=_.template(b),d=c(a);this.$el.find("#selectSeat").before(d)},events:{"click #js_return":"backAction","click .js_btn_submit":"submitAction"},backAction:function(){var a=this.selectSeat.getSelectInfo(),c=a.currentInfo;if(c.length>0){var d=new b.ui.Alert({title:"提示信息",message:"所选座位尚未提交，是否确定要离开当前页面？",buttons:[{text:"取消",click:function(){this.hide()}},{text:"确定",click:function(){this.hide(),k.clearSelSetno(),k.back(i?i:"index")}}]});d.show()}else k.clearSelSetno(),this.back(i?i:"index")},clearSelSetno:function(){if(!j){var a=n.getAttr("ciplst");if(!a)return;for(var b=0,c=a.length;c>b;b++)a[b].setno="";n.setAttr("ciplst",a)}},submitAction:function(){var a=this.selectSeat.getSelectInfo(),c=a.currentInfo;n.setAttr("currentSpace",a.currentSpace);var d=n.getAttr("ciplst");if(c&&c.length!=this.data.user.length){var e=new b.ui.Alert({message:"还有"+(this.data.user.length-c.length)+"人未选择座位",buttons:[{text:"确定",click:function(){this.hide()}}]});return void e.show()}for(var f=0,g=c.length;g>f;f++)for(var h=c[f].split("-"),i=0,k=d.length;k>i;i++)d[i].uindex==h[1]&&(d[i].setno=h[2]);if(n.setAttr("ciplst",d),j){this.selectSeat.getSelectInfo(),m.setParam({fcsinf:{acode:n.getAttr("aacode"),dcode:n.getAttr("dacode"),ddate:n.getAttr("depdat"),fno:n.getAttr("fno"),setno:d[0].setno},oid:n.getAttr("oid"),psginf:{cno:n.getAttr("ciplst")[0].cno,ctype:n.getAttr("ciplst")[0].ctype,phone:n.getAttr("ciplst")[0].phone,psgname:n.getAttr("ciplst")[0].psgnam,tno:null},ver:0});var l=this,p=function(){m.excute(function(a){l.hideLoading(),0==a.rc?(n.setAttr("cattion",a.cattion),l.forward("checkinsuccess")):l.showToast("值机失败",2,function(){})},function(a){l.hideLoading(),a&&a.msg?l.showToast(a.msg,2,function(){}):l.showToast("数据加载失败",2,function(){})},!1,l)};this.showLoading(),o.isLogin()?p():$.ajax({url:"/html5/Account/NonUserLogin",data:n.getAttr("ciplst")[0].phone,type:"post",dataType:"json",timeout:2e5,success:function(a){a&&1==+a.ServerCode?(1==a.Data.IsNonUser&&(a.Data.LoginToken=""),o.removeUser(),o.setUser({UserID:a.Data.UserID,IsNonUser:!0,LoginToken:"",LoginName:null,Auth:a.Data.Auth,ExpiredTime:null}),p()):l.showToast("用户信息过期！")},error:function(){l.showToast("用户信息过期！")}})}else this.forward("seatconfirm")},onCreate:function(){k=this},onLoad:function(){var a=this;if(!n.get())return void this.back("index");i=n.getAttr("backurl"),j="notimedcheckin"==i?!1:!0;var b={fno:n.getAttr("fno"),oid:n.getAttr("oid")||0,ver:0};j?(b.otyp=2,b.paginf={cno:n.getAttr("ciplst")[0].cno,ctype:n.getAttr("ciplst")[0].ctype,phone:n.getAttr("ciplst")[0].phone,psgname:n.getAttr("ciplst")[0].psgnam},b.fckin={acode:n.getAttr("aacode"),dcode:n.getAttr("dacode"),ddate:n.getAttr("depdat")}):b.otyp=1,l.setParam(b),this.showLoading(),l.excute(function(a){this.data.seatChart.setcollst=a.setcollst,this.data.user=[];var b=n.getAttr("ciplst");if(b)for(var c=0,e=b.length;e>c;c++){var f={name:n.getAttr("ciplst")[c].psgnam,cno:c+1,setno:n.getAttr("ciplst")[c].setno&&n.getAttr("ciplst")[c].setno.trim()};b[c].uindex=c+1,this.data.user.push(f)}n.setAttr("ciplst",b),this.hideLoading(),this.data.checkIn=j?1:0,this.$el.html(h),this.selectSeat=new d({el:this.$el.find("#selectSeat"),data:this.data}),this.render(),this.turning(),this.$el.find(".js_btn_submit").html(j?"提交":"确定"),this.$el.find("[data-role='seatUserName']").html(b[0].psgnam)},function(b){b&&b.msg?setTimeout(function(){a.showToast(b.msg,0,function(){a.back(i?i:"index")})},1e3):setTimeout(function(){a.showToast("数据加载失败",0,function(){a.back(i?i:"index")})},1e3)},!0,this)},onShow:function(){},onHide:function(){},data:{checkIn:!0,seatChart:{head:{auth:null,errcode:0},cfttpe:"",subcls:"Y"}}});return p});