define(["libs","c","CommonStore","FlightStore","FlightModel","cMultipleDate",buildViewTemplatesPath("transit.html"),"cWidgetFactory"],function(a,b,c,d,e,f,g){var h=(b.ui,b.base),i=(c.SalesObjectStore.getInstance(),c.UserStore.getInstance()),j=!1,k=b.view.extend({pageid:"",tpl:g,flightStore:d.FlightSearchStore.getInstance(),flightCityListStore:d.FlightCityListStore.getInstance(),flightInterCityListStore:d.FlightInterCityListStore.getInstance(),flightFilterStore:d.FlightFilterStore.getInstance(),openApp:function(){function a(){return function(){if(window.location=c,G){{+new Date}setTimeout(function(){window.location="itms-apps://itunes.apple.com/cn/app/id379395415?mt=8"},1)}}()}var b=this,c="",d="",e="ctrip://wireless",f="";if(window.localStorage&&null!=window.localStorage.getItem("SALES")&&""!=window.localStorage.getItem("SALES")){var g=JSON.parse(window.localStorage.getItem("SALES"));null!=g.data&&(f=g.data.sourceid)}var k=b.flightStore.getSearchDetails(0,"dkey"),l=b.flightStore.getSearchDetails(0,"akey"),m=b.flightStore.getSearchDetails(0,"date"),n=h.Date.parse(m,!0);n=h.Date.format(n,"Y/m/d"),m=n.replace(/\//g,"");var o=b.flightStore.getAttr("tabtype")||1,p=b.flightStore.getAttr("amode")-2==0||b.flightStore.getAttr("dmode")-2==0?2:1,q=b.getQuery("page");switch(q){case"index":if(1==o)c="/flight_inquire?c1="+o+"&c2="+k+"&c3="+l+"&c4="+m+"&extendSourceID="+f;else{var r=b.flightStore.getSearchDetails(1,"date"),s=h.Date.parse(r,!0);s=h.Date.format(s,"Y/m/d"),r=s.replace(/\//g,""),c="/flight_inquire?c1="+o+"&c2="+k+"&c3="+l+"&c4="+m+"&c5="+r+"&extendSourceID="+f}d="/webapp/flight/#index";break;case"list":var t=p-2==0?"/flight_int_singlelist?":"/flight_inland_singlelist?",u=p-2==0?"/flight_int_tolist?":"/flight_inland_tolist?";if(d=p-2==0?"/webapp/fltintl/#flightlist":"/webapp/flight/#list",1==o)c=t+"c1="+o+"&c2="+k+"&c3="+l+"&c4="+m+"&extendSourceID="+f;else{var r=b.flightStore.getSearchDetails(1,"date"),s=h.Date.parse(r,!0);s=h.Date.format(s,"Y/m/d"),r=s.replace(/\//g,""),c=u+"c1="+o+"&c2="+k+"&c3="+l+"&c4="+m+"&c5="+r+"&extendSourceID="+f}p-2==0&&b.flightStore.saveToFltintlSearch();break;case"order":var v=b.getQuery("oid"),w="";b.getQuery("uid")&&(w="&UserID="+b.getQuery("uid")),i&&i.getUser()&&(w="&UserID="+i.getUser().LoginName),(""==v||null==v||""==w||null==w)&&(j=!0),c="/InlandFlightOrder?orderId="+v+w+"&extendSourceID="+f,d="/webapp/flight/#flightorderdetail?oid="+v;break;case"intlorder":var v=b.getQuery("oid"),w="";b.getQuery("uid")&&(w="&UserID="+b.getQuery("uid")),i&&i.getUser()&&(w="&UserID="+i.getUser().LoginName),(""==v||null==v||""==w||null==w)&&(j=!0),c="/InternationalFlightOrder?orderId="+v+w+"&extendSourceID="+f,d="/webapp/fltintl/#fltintlorderdetail?oid="+v;break;case"refund":var v=b.getQuery("oid"),w="";b.getQuery("uid")&&(w="&UserID="+b.getQuery("uid")),i&&i.getUser()&&(w="&UserID="+i.getUser().LoginName),(""==v||null==v||""==w||null==w)&&(j=!0),c="/flight_inland_refund?c1="+v+w+"&extendSourceID="+f,d="/webapp/flight/#ticketrefund?oid="+v;break;case"intlrefund":var v=b.getQuery("oid"),w="";b.getQuery("uid")&&(w="&UserID="+b.getQuery("uid")),i&&i.getUser()&&(w="&UserID="+i.getUser().LoginName),(""==v||null==v||""==w||null==w)&&(j=!0),c="/flight_int_refund?c1="+v+w+"&extendSourceID="+f,d="/webapp/fltintl/#fltintlrefundticket?oid="+v;break;case"change":var v=b.getQuery("oid"),w="";b.getQuery("uid")&&(w="&UserID="+b.getQuery("uid")),i&&i.getUser()&&(w="&UserID="+i.getUser().LoginName),(""==v||null==v||""==w||null==w)&&(j=!0),c="/flight_inland_change?c1="+v+w+"&extendSourceID="+f,d="/webapp/flight/#flightordermodify?oid="+v;break;case"bdindex":var x=b.getQuery("dport")||"SHA",y=b.getQuery("aport")||"PEK",z=b.getQuery("qdate")||h.Date.format(new Date,"Y/m/d");c="/flight_board_inquire?c1="+z+"&c2="+x+"&c3="+y+"&extendSourceID="+f,d="/html5/flight/schedule/index.html";break;case"board":var A=b.getQuery("fltno")||"",x=b.getQuery("dport")||"",y=b.getQuery("aport")||"",z=b.getQuery("qdate")||"";A=A.toUpperCase(),x=x.toUpperCase(),y=y.toUpperCase(),""!=A&&""!=x&&""!=y&&""!=z?(c="/flight_board_detail?c1="+z+"&c2="+A+"&c3="+x+"&c4="+y+"&extendSourceID="+f,d="/html5/flight/schedule/"+A+".html?ddate="+z):(c="/flight_board_inquire?c1="+z+"&c2="+x+"&c3="+y+"&extendSourceID="+f,d="/html5/flight/schedule/index.html")}if(1==j){if(1==o)c="/flight_inquire?c1="+o+"&c2="+k+"&c3="+l+"&c4="+m+"&extendSourceID="+f;else{var r=b.flightStore.getSearchDetails(1,"date"),s=h.Date.parse(r,!0);s=h.Date.format(s,"Y/m/d"),r=s.replace(/\//g,""),c="/flight_inquire?c1="+o+"&c2="+k+"&c3="+l+"&c4="+m+"&c5="+r+"&extendSourceID="+f}d="/webapp/flight/#index"}c=e+c;var B={appUrl:c,h5Url:d},c=B.appUrl,d=B.h5Url,C=navigator.userAgent?navigator.userAgent.toLocaleLowerCase():"",D=-1!=C.indexOf("mac",0)||-1!=navigator.userAgent.indexOf("ios",0)?1:0,E=-1!=C.indexOf("android",0)||-1!=C.indexOf("adr",0)?1:0,F=E&&-1!=C.indexOf("chrome",0)&&-1==C.indexOf("nexus",0),G=navigator.userAgent.indexOf("Safari")>-1&&navigator.userAgent.indexOf("Chrome")<1;if(E)if(F)window.location.href=c,setTimeout(function(){window.location.href=d},1);else{var H=$('<iframe style="display: none;"></iframe>');H.attr("src",c),$("body").append(H),setTimeout(function(){window.location.href=d},3e3)}else D?(a(),setTimeout(function(){window.location.href=d},3e3)):(window.location=c,setTimeout(function(){window.location.href=d},3e3))},getQueryStringByName:function(a){var b=location.search.match(new RegExp("[?&]"+a+"=([^&]+)","i"));return null==b||b.length<1?"":b[1]},render:function(){this.viewdata.req=this.request,this.$el.html(this.tpl),this.els={}},renderPage:function(a,b,c,d,e){var f=this,g=!1;if(null!=d&&null!=e){var h="",i="",j="",k="",l="",m="";if(d&&d.length>0)for(var n=0,o=d.length;o>n;n++)c&&""!=c&&(d[n].code.toLowerCase()==c.toLowerCase()||d[n].name==decodeURI(c)||d[n].id==c)&&(i=d[n].name,h=d[n].code,j=d[n].id,f.flightStore.setAttr("amode","1")),b&&""!=b&&(d[n].code.toLowerCase()==b.toLowerCase()||d[n].name==decodeURI(b)||d[n].id==b)&&(l=d[n].name,k=d[n].code,m=d[n].id,f.flightStore.setAttr("dmode","1"));if(e&&e.length>0){for(var n=0,o=e.length;o>n;n++)c&&""!=c&&(e[n].code.toLowerCase()==c.toLowerCase()||e[n].name==decodeURI(c)||e[n].id==c)&&(i=e[n].name,h=e[n].code,j=e[n].id,g=!0,f.flightStore.setAttr("amode","2")),b&&""!=b&&(e[n].code.toLowerCase()==b.toLowerCase()||e[n].name==decodeURI(b)||e[n].id==b)&&(l=e[n].name,k=e[n].code,m=e[n].id,g=!0,f.flightStore.setAttr("dmode","2"));1==g&&f.flightStore.setAttr("tofltintl","0")}(""==j||""==i)&&(h="BJS",j=1,i="北京"),(""==m||""==l)&&(k="SHA",m=2,l="上海"),a-2==0?(f.flightStore.setSearchDetails(0,"dCtyCode",k),f.flightStore.setSearchDetails(0,"dcityName",l),f.flightStore.setSearchDetails(0,"dkey",m),f.flightStore.setSearchDetails(0,"aCtyCode",h),f.flightStore.setSearchDetails(0,"acityName",i),f.flightStore.setSearchDetails(0,"akey",j),f.flightStore.setSearchDetails(1,"aCtyCode",k),f.flightStore.setSearchDetails(1,"acityName",l),f.flightStore.setSearchDetails(1,"akey",m),f.flightStore.setSearchDetails(1,"dCtyCode",h),f.flightStore.setSearchDetails(1,"dcityName",i),f.flightStore.setSearchDetails(1,"dkey",j)):(f.flightStore.setSearchDetails(0,"dCtyCode",k),f.flightStore.setSearchDetails(0,"dcityName",l),f.flightStore.setSearchDetails(0,"dkey",m),f.flightStore.setSearchDetails(0,"aCtyCode",h),f.flightStore.setSearchDetails(0,"acityName",i),f.flightStore.setSearchDetails(0,"akey",j),f.flightStore.removeSearchDetails(1)),f.flightStore.setAttr("ticketIssueCty",k),f.flightStore.setCurSearchDetails([0]),f.openApp()}},updatePage:function(){var a=this,b=a.getQuery("page"),c=""!=a.getQuery("SearchType")&&null!=a.getQuery("SearchType")?a.getQuery("SearchType"):""!=a.getQuery("flighttype")&&null!=a.getQuery("flighttype")?a.getQuery("flighttype"):""!=a.getQuery("trip")&&null!=a.getQuery("trip")?a.getQuery("trip"):"";c=c.toLowerCase(),"d"==c?c=2:"s"==c?c=1:""==c&&"list"==b&&(j=!0);var d=a.flightStore.getAttr("tabtype")||1;c=c||1,""!=c&&(a.flightStore.setAttr("tabtype",c),a.flightStore.setAttr("__tripType",c),a.flightStore.setAttr("tripType",c),d=c);var e=""!=a.getQuery("ddate1")&&null!=a.getQuery("ddate1")?a.getQuery("ddate1"):""!=a.getQuery("dtime")&&null!=a.getQuery("dtime")?a.getQuery("dtime"):"";""==e||0==a.IsDate(e)?"list"==b&&(j=!0):(e=h.Date.parse(e,!0),e=h.Date.format(e,"Y/m/d"),a.flightStore.setSearchDetails(0,"date",e));var f=""!=a.getQuery("ddate2")&&null!=a.getQuery("ddate2")?a.getQuery("ddate2"):""!=a.getQuery("atime")&&null!=a.getQuery("atime")?a.getQuery("atime"):"";if(d-2==0&&(""==f||0==a.IsDate(f)?"list"==b&&(j=!0):(f=h.Date.parse(f,!0),f=h.Date.format(f,"Y/m/d"),a.flightStore.setSearchDetails(1,"date",f))),""==e&&""==f){var g=""!=a.getQuery("dday")&&null!=a.getQuery("dday")?parseInt(a.getQuery("dday")):""!=a.getQuery("dayoffset")&&null!=a.getQuery("dayoffset")?parseInt(a.getQuery("dayoffset")):"";if(0==isNaN(g)&&g>0){var i=new h.Date(h.getServerDate()).addDay(g).format("Y/m/d"),k=new h.Date(h.getServerDate()).addDay(g+1).format("Y/m/d");d-2==0?(a.flightStore.setSearchDetails(0,"date",i),a.flightStore.setSearchDetails(1,"date",k)):a.flightStore.setSearchDetails(0,"date",i)}else{var i=new h.Date(h.getServerDate()).addDay(1).format("Y/m/d"),k=new h.Date(h.getServerDate()).addDay(2).format("Y/m/d");d-2==0?(a.flightStore.setSearchDetails(0,"date",i),a.flightStore.setSearchDetails(1,"date",k)):a.flightStore.setSearchDetails(0,"date",i)}}var l=""!=a.getQuery("dcity")&&null!=a.getQuery("dcity")?a.getQuery("dcity"):""!=a.getQuery("_dcity")&&null!=a.getQuery("_dcity")?a.getQuery("_dcity"):""!=a.getQuery("departure")&&null!=a.getQuery("departure")?a.getQuery("departure"):"",m=""!=a.getQuery("acity")&&null!=a.getQuery("acity")?a.getQuery("acity"):""!=a.getQuery("_acity")&&null!=a.getQuery("_acity")?a.getQuery("_acity"):""!=a.getQuery("arrival")&&null!=a.getQuery("arrival")?a.getQuery("arrival"):"";if((""==l||""==m)&&("list"==b&&(j=!0,""==l&&(l="sha"),""==m&&(m="bjs")),"index"==b&&(""==l&&(l="sha"),""==m&&(m="bjs"))),""!=l||""!=m){var n=null,o=null;null!=a.flightCityListStore.get()&&null!=a.flightInterCityListStore.get()?(n=a.flightCityListStore.get(),o=a.flightInterCityListStore.get(),a.renderPage(d,l,m,n.cities,o.cities)):a.baseDataModel.excute(function(b){a.renderPage(d,l,m,b.flightCityList.cities,b.flightInterCityList.cities)},function(){},a,a)}else"list"==b&&(j=!0),a.openApp();a.turning()},IsDate:function(a){var b=/^(?:(?!0000)[0-9]{4}-(?:(?:0[1-9]|1[0-2])-(?:0[1-9]|1[0-9]|2[0-8])|(?:0[13-9]|1[0-2])-(?:29|30)|(?:0[13578]|1[02])-31)|(?:[0-9]{2}(?:0[48]|[2468][048]|[13579][26])|(?:0[48]|[2468][048]|[13579][26])00)-02-29)$/;return b.exec(a)?!0:!1},onCreate:function(){this.render(),this.baseDataModel=new f({models:{flightCityList:e.FlightCityListModel.getInstance(),flightInterCityList:e.FlightInterCityListModel.getInstance()}})},onLoad:function(){var a=this;a.updatePage()},onShow:function(){this.setTitle("携程机票")},onHide:function(){}});return k});