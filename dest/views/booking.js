define(["cSales","cWidgetMember","vFlightInfo","vPassenger","vVouchers","vPayment","vOrder","vInsurance","vTravelPackages","vDataControl","widgetHidden","libs","c","cUI","MultipleScrollList","adLoad","CommonStore","flight/utility/utility","FlightStore","FlightModel","CPageModel","CPageStore","InvoiceStore",buildViewTemplatesPath("../modules/bookingInfo/templates/index.html"),"cUtilityCrypt","cWidgetFactory","relationship","cWidgetCalendar"],function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A){window.__isRequireBookininfoSucc=!0;var B,C=z.create("Member"),D=t.FlightDetailModel.getInstance(),E=s.FlightSearchStore.getInstance(),F=s.FlightDetailsStore.getInstance(),G=s.FlightSelectedInfo.getInstance(),H=v.passengerQueryStore.getInstance(),I=u.passengerEditModel.getInstance(),J=v.passengerEditStore.getInstance(),K=v.isBookingEditStore.getInstance(),L=v.PostCityStore.getInstance(),M=u.PostCityModel.getInstance(),N=s.FlightOrderInfoStore.getInstance(),O=t.FlightOrderSumbitModel.getInstance(),P=s.FlightPickTicketSelectStore.getInstance(),Q=v.CustomerAddrStore.getInstance(),R=s.zqInAirportDateAndAddressStore.getInstance(),S=q.UserStore.getInstance(),T=S?S.getUser():null,U=q.SalesObjectStore.getInstance(),V=q.UnionStore.getInstance(),W=m.base,X=v.passPageTypeStore.getInstance(),Y=u.passengerQueryModel.getInstance(),Z=s.FlightListStore.getInstance(),ab=u.CustomerAddrQueryModel.getInstance(),bb=v.CustomerAddrListStore.getInstance(),cb=v.AddressStore.getInstance(),db=z.create("Calendar"),eb=(z.create("Guider"),t.FlightPickTicketModel.getInstance()),fb=s.FlightPickTicketStore.getInstance(),gb=u.CustomerAddrEditModel.getInstance(),hb=s.zqInAirportSelectStore.getInstance(),ib=v.SelectAddrStore.getInstance(),jb=s.FlightCabinParamStore.getInstance(),kb=s.FlightCabinStore.getInstance(),lb=s.OrderCreateStore.getInstance(),mb=w.InvoiceURLStore.getInstance(),nb=w.Flight_InvoiceTitle.getInstance(),ob=null,pb=null,qb=null,rb=null,sb=null,tb=t.FlightOrderCreateModel.getInstance(),ub=t.CustomerCouponModel.getInstance(),vb=s.CustomerCouponStore.getInstance(),wb=t.RepeatOrderCheckModel.getInstance(),xb=s.RepeatOrderCheckStore.getInstance(),yb=t.AddrCheckModel.getInstance(),zb=s.PackageSelectStore.getInstance(),Ab=s.MdTransStore.getInstance(),Bb=s.MdBookingStore.getInstance(),Cb=v.ShowLoginStore.getInstance(),Db=s.FlightOrderInfoInviceStore.getInstance(),Eb=s.FlightBookingResultStore.getInstance(),Fb=s.FlightCCBStore.getInstance(),Gb=new p,Hb=new m.base.Class(m.ui.Layer,{__propertys__:function(){var a=this;this.contentDom,this.mask=new m.ui.Mask,this.mask.addEvent("onShow",function(){$(window).bind("resize",this.onResize),this.onResize();var b=this;this.root.bind("click",function(){b.hide(),b.root.unbind("click"),a.hide()})})},initialize:function($super,a){$super({onCreate:function(){},onShow:function(){for(var b in a)this[b]=a[b];this.mask.show(),this.setzIndexTop(),"string"==typeof this.html&&(this.html=$(this.html)),this.contentDom.html(this.html),this.closeDom&&this.contentDom.find(this.closeDom).on("click",function(){pb&&pb.hide()})},onHide:function(){this.mask&&this.mask.hide()}})}});return B=m.view.extend({pageid:"214279",tpl:x,vFlightInfo:null,vPassenger:null,vVouchers:null,vPayment:null,vOrder:null,vInsurance:null,vTravelPackages:null,render:function(){this.showLoading(),this.$el.html(this.tpl),this.elsBox={infobox_box:this.$el.find("#flightInfo"),insure_tpl:this.$el.find("#insure_tpl"),insure_box:this.$el.find("#insure"),coupons_tpl:this.$el.find("#couponstpl"),coupons_box:this.$el.find("#couponsbox"),pay_tpl:this.$el.find("#paytpl"),pay_box:this.$el.find("#paybox"),hfb_tpl:this.$el.find("#hfbtpl"),hfb_box:this.$el.find("#hfb_box"),delivery_tpl:this.$el.find("#deliverytpl"),delivery_box:this.$el.find("#deliverybox"),deliverytpl_tab:this.$el.find("#deliverytpl_tab"),deliverytpl_mail_1:this.$el.find("#deliverytpl_mail_1"),deliverytpl_mail_2:this.$el.find("#deliverytpl_mail_2"),deliverytpl_zq:this.$el.find("#deliverytpl_zq"),lxtc_box:this.$el.find("#lxtc_box"),lxtc_tpl:this.$el.find("#lxtctpl"),notice_box:this.$el.find("#notice_box"),notice_tpl:this.$el.find("#notice_tpl"),package_tpl:this.$el.find("#packageTmp"),package_box:this.$el.find("#package"),error_tips:this.$el.find(".error-tips"),orderDetail:this.$el.find("#order-detail"),orderDetail_tpl:this.$el.find("#order-detail-tpl")},this.couponstplfun=_.template(this.elsBox.coupons_tpl.html()),this.noticetplfun=_.template(this.elsBox.notice_tpl.html()),this.paytplfun=_.template(this.elsBox.pay_tpl.html()),this.packagefun=_.template(this.elsBox.package_tpl.html()),this.orderDetailtplfun=_.template(this.elsBox.orderDetail_tpl.html())},stores:{flightSearchStore:E,flightDetailsStore:F,selFlightInfoStore:G,passengerQueryStore:H,passengerEditStore:J,isBookingEditStore:K,postCityStore:L,flightOrderStore:N,flightDeliveryStore:P,flightOrderInfoInviceStore:Db,postAddressStorage:Q,airportDeliveryStore:R,userStore:S,salesStore:U,unionStore:V,passPageTypeStore:X,flightListStore:Z,addrListStore:bb,addressStore:cb,flightPickTicketStore:fb,zqInAirportSelectStore:hb,selAddrStore:ib,cabinParamStore:jb,cabinStore:kb,orderCreateStore:lb,invoiceURLStore:mb,invoiceTitleStore:nb,customerCouponStore:vb,repeatOrderCheckStore:xb,packageSelectStore:zb,mdTransStore:Ab,mdStore:Bb,ShowLoginStore:Cb},models:{flightOrderCreateModel:tb,flightDetailModel:D,passengerEditModel:I,postCityModel:M,flightOrderSumbitModel:O,passengerQueryModel:Y,addrListModel:ab,flightPickTicketModel:eb,addrOprModel:gb,customerCouponModel:ub,RepeatOrderCheckModel:wb,addrCheckModel:yb},events:{"click #js_return":"backAction","click div[data-rbtType]":"showRebate","click #paybtn .j_btn":"beforePayAction","input #linkTel":"setContact","click #addPassenger .flight-labq":"readmeAction","click .jsDelivery":"selDelivery","click #jsViewCoupons":"viewCoupons","click .j_refundPolicy":"fanBoxAction","click .js_del_tab":"showDelListUI","click #js_addrList":"AddrListAction","click #date-picker":"calendarAction","click #done-address":"zqinairselect","click #selectCity":"selectCityAction","click #date-zqtime":"showZqTimeUI","click #jsinsure":"viewInsure","change #js_invoice_title":"inTitleChangeWrp","click .flight-icon-arrrht":"showinTitleList","focusout #linkTel":"telInputFinish","touchstart input":"touchStartAction","click #package .flight-arrrht":"packageSelect","focusin input":"hideErrorTips","click .j_PackageNotice":"toggletips","click .j_AnnouncementNotice":"toggleNotice","click #travalPackageDesc":"forwardToTravalPackage","click #paybtn":"orderDetailAction"},onCreate:function(){ob=this;G.get(),E.get();this.render(),this.$el.on("focus","input",function(){ob.$el.find(".js_fixed").addClass("pos-rl"),$(".flight-header-blank").hide()}).on("focusout","input",function(){ob.$el.find(".js_fixed").removeClass("pos-rl"),$(".flight-header-blank").show()})},onLoad:function(a){DataControl="undefined"==typeof DataControl?new j(this):DataControl;var b={viewPort:this.$el,parentView:this};this.vFlightInfo=this.vFlightInfo||new c(_.extend({},b,{personalArgu:"vFlightInfo"})),this.vPassenger=this.vPassenger||new d(_.extend({},b,{personalArgu:"vPassenger"})),this.vVouchers=this.vVouchers||new e(_.extend({},b,{personalArgu:"vVouchers"})),this.vInsurance=this.vInsurance||new h(_.extend({},b,{personalArgu:"vInsurance"})),this.vTravelPackages=this.vTravelPackages||new i(_.extend({},b,{personalArgu:"vTravelPackages"})),this.widgetHidden=this.widgetHidden||new k(_.extend({},b,{personalArgu:"vHidden"})),this.vPayment=this.vPayment||new f(_.extend({},b,{personalArgu:"vPayment"})),this.vOrder=this.vOrder||new g(_.extend({},b,{personalArgu:"vOrder"})),this.fireInterfaceEvents();var l=this;if(l.turning(),!this.vFlightInfo.render()){if(this.widgetHidden.onLoad(),l.showLoading(),!l.uid)if(S.isLogin()){var n=S.getUser();l.uid=n.UserID}else l.uid=m.utility.getGuid();if(!this.SEOQuery())return void this.forward("#index");{(function(a,b,c,d,e,f,g){var h=a.get(),i=b.get();if(!h||!i||!i.items)return g.hideLoading(),g.showAlert(),!1;var j=1,k=h.depart.cabin.pid;h.arrive&&h.arrive.cabin&&i.tripType&&+i.tripType>1&&(j=2,k=h.depart.cabin.pid+","+h.arrive.cabin.pid),c.setParam("prdid",k),c.setParam("polid","0"),c.setParam("triptype",j)})(G,E,D,U,W,S,l),function(b,c,d,e,f){var g=b.getUser();g&&(g.VipGrade&&c.setParam("ugrade",g.VipGrade),g.Auth&&c.getHead().setAttr("auth",g.Auth)),c.setParam("ver",0);d.get()||{type:1};l.updateDelList(function(){l.updatePage(function(){l.$el.parents("body").find("#dl_app").hide(),("flightorderdetail"==a||"flightorderlist"==a)&&l.repeatAlert&&l.repeatAlert.show()})},e,f)}(S,D,P,G,E),function(a,b,c){var d=a.getItem("__REPEAT_ORDER"),e=b.get();if("true"==d&&e){var f=e.msg,g=e.repeatOrder;c.repeatAlert=new m.ui.Alert({title:"重复订单提醒",message:f,buttons:[{text:"取消",click:function(){this.hide(),a.setItem("__REPEAT_ORDER",!1),b.remove()}},{text:"查看订单",click:function(){c.jump(g&&g.length>1?"/webapp/myctrip/#orders/flightorderlist?from="+encodeURIComponent("/webapp/flight/#bookinginfo"):"/webapp/flight/#flightorderdetail?from="+encodeURIComponent("/webapp/flight/#bookinginfo")+"&&oid="+g[0]),this.hide(),a.setItem("__REPEAT_ORDER",!0)}},{text:"继续预订",click:function(){this.hide(),c.isRepeatOrder=!0,c.payAction(),a.setItem("__REPEAT_ORDER",!1),b.remove()}}]}),c.repeatAlert.show()}}(localStorage,xb,l)}this.getSalesObj(q);{(function(a,b){a.getAttr("isCCB")&&(b.$el.find("#js_flight-top").hide(),b.$el.find(".flight-loginline-fixed").hide(),b.$el.find(".flight-loginline").hide())})(Fb,l)}}},SEOQuery:function(){var a=this.getQuery("dcity"),b=this.getQuery("acity"),c=this.getQuery("ddate"),d=this.getQuery("flight"),e=this.getQuery("class"),f=this.getQuery("subclass"),g=this.getQuery("price"),h=+this.getQuery("producttype")||0,i=this.getQuery("allianceid"),j=this.getQuery("ouid"),k=this.getQuery("sid"),l=this.getServerDate(),n=l.getFullYear()+"/"+(l.getMonth()+1)+"/"+l.getDate();if(!(a&&a!==!0&&b&&b!==!0&&c&&c!==!0&&d&&d!==!0&&e&&e!==!0&&f&&f!==!0&&g&&g!==!0&&h&&!(m.base.Date.parse(c).valueOf()<m.base.Date.parse(n).valueOf())))return!1;switch(i&&1!=i&&k&&1!=k&&+i>0&&+k>0&&(j&&1!=j||(j=""),V.set({AllianceID:i,OUID:j,SID:k})),h){case 0:h="NA";break;case 1:h="Normal";break;case 2:h="SingleTrip";break;case 3:h="RoundTrip";break;case 4:h="AirHotel";break;case 5:h="Corperation";break;case 6:h="OPRound";break;case 7:h="OPSingle";break;case 8:h="OLDMAN";break;case 9:h="YOUNGMAN";break;case 10:h="Transit";break;case 11:h="SingleRule"}var o={fno:d.toUpperCase(),ddate:c,dcity:a.toUpperCase(),acity:b.toUpperCase(),pty:h,grade:f.toUpperCase(),price:+g,rebate:0,stype:null,cut:1,flag:0};return G.setAttr("depart",{cabin:{pid:JSON.stringify(o)},rebateAmt:0}),!0},EVENTS:{DETAILCOMPLETE:"flightDetailComplete",PASSENGERSCOMPLETE:"passengersComplete",INSURANCERENDER:"insuranceRender",SWITCHINSURETRIGGER:"switchInsureTrigger",TOGGLEPACKAGEDESC:"togglePackageDesc",UPDATEPACKAGETPL:"updatePackageTpl",UPDATEORDERPRICE:"updateOrderPrice",hasChildrenOrBaby:"hasChildrenOrBaby"},hasChildrenOrBaby:function(a){return this.vPassenger.hasChildrenOrBaby(a)},fireInterfaceEvents:function(){this.on(this.EVENTS.SWITCHINSURETRIGGER,this.switchInsure.bind(this)),this.on(this.EVENTS.UPDATEORDERPRICE,this.updateOrderPrice.bind(this))},updateOrderPrice:function(){{var a=this.vPayment[this.vPayment.EVENTS.ACCOUNTTOTALPRICE](),b=$("#paybox .fs");b.data("amt")}b.data("amt",a),b.text(a>0?a:"----")},onShow:function(){this.setTitle("机票预订")},getSalesObj:function(b){var c=this,d=c.getQuery("sales"),e=c.getQuery("sourceid"),f=b.SalesStore.getInstance().get();null!=f&&null==e&&null==d&&(e=f.sourceid),(d||e)&&a.getSalesObject(d||e,$.proxy(function(){a.replaceContent(c.$el)},this))},onHide:function(){this.hideHeadWarning(),this.hideLoading(),S.isLogin()||$("header").removeClass("pos-ab"),$("#flightBox").hide(),$("#paybox").hide(),Gb.hide()},updatePage:function(a){var b=this,c={};DataControl.reqFlags.DETAIL=!1,DataControl.reqFlags.PASSENGERS=!1,DataControl.reqFlags.HASPASSENGER=!1,DataControl.reqFlags.PASSENGERSFAIL=!1,b.vFlightInfo[b.vFlightInfo.EVENTS.GETFLIGHTDETAIL](function(e){b.trigger(b.EVENTS.DETAILCOMPLETE,c,e,DataControl.reqFlags),DataControl.reqFlags.DETAIL=!0,a&&a(),DataControl.reqFlags.PASSENGERS&&d.hideLoading()});var d=this;S.isLogin()?(this.UserID=S.getUser().UserID,H.setLifeTime("60M"),Y.setParam("UserId",this.UserID),d.showLoading(),Y.excute(function(a){b.trigger(b.EVENTS.PASSENGERSCOMPLETE,c,a,DataControl.reqFlags),DataControl.reqFlags.PASSENGERS=!0,DataControl.reqFlags.DETAIL&&d.hideLoading()},function(a){DataControl.reqFlags.PASSENGERSFAIL=!0,b.trigger(b.EVENTS.PASSENGERSCOMPLETE,c,a,DataControl.reqFlags),DataControl.reqFlags.DETAIL&&d.hideLoading()},!1,this)):(this.UserID=this.UserID||m.utility.getGuid(),this.trigger(this.EVENTS.PASSENGERSCOMPLETE,c,null,DataControl.reqFlags),DataControl.reqFlags.PASSENGERS=!0,DataControl.reqFlags.DETAIL&&d.hideLoading());!function(a,b,c,d,e){var f=a.getUser();f&&0==f.IsNonUser&&e.$el.find("#linkTel").val(f.Mobile?f.Mobile:"");var g=b.get();if(g&&g.contact){var h=g.contact;h.mphone&&h.mphone.trim().length>0&&e.$el.find("#linkTel").val(h.mphone.trim())}d.getAttr("isCCB")&&$(".flight-loginline").hide()}(S,N,H,Fb,d)},toggleNotice:function(){$(".j_AnnouncementNotice").toggleClass("flight-htauto"),$(".j_AnnouncementNotice").children(".flight-arrdn5").toggleClass("flight-arrup5")},toggletips:function(){$(".j_PackageNotice").toggleClass("flight-htauto"),$(".j_PackageNotice").children(".flight-arrdn3").toggleClass("flight-arrup3")},backAction:function(a){var b=(S.getUser(),F.get()),c=N.get();c=c?c:{},N.setAttr("delivery",null),N.setAttr("flightInfos",null),N.setAttr("insurance",null),N.setAttr("order",null),N.setAttr("selInsure","1");var d="#list";if(a&&+a>0){b&&b.items&&b.items.length>1&&(d=1==+a?"#list":"#backlist"),F.remove(),ob.back(d);try{Bb.setAttr("IsReturn",!0),this.widgetHidden.mdSubmit()}catch(e){0}}else this.backAlert=new m.ui.Alert({title:"提示信息",message:"您的订单尚未完成，确定要离开吗？",buttons:[{text:"取消",click:function(){this.hide();try{Bb.setAttr("IsReturn",!0)}catch(a){0}}},{text:"确定",click:function(){this.hide(),b&&b.items&&b.items.length>1&&(d="#backlist"),ob.hideLoading(),ib.remove(),J.remove(),R.remove(),fb.remove(),ob.repeatAlert=!1,setTimeout(function(){ob.back(Z.get()||3!==window.localStorage.length?d:"index");try{Bb.setAttr("IsReturn",!0),ob.widgetHidden.mdSubmit()}catch(a){0}},200)}}]}),this.backAlert.show()},forwardToTravalPackage:function(){this.forward("#travalpackagesdesc")},bookLogin:function(){Bb.setAttr("IsClickLogin",!0),N.setAttr("selInsure","1"),S.isLogin()||(this.showLoading(),C.memberLogin({param:"from="+encodeURIComponent("/webapp/flight/#bookinginfo")+"&t=1"}))},readmeAction:function(){var a=['<div class="flight-windows">','<div class="flight-windows-hd">姓名填写说明<i class="flight-icon-close"></i></div>',' <div class="flight-windows-bd">'," <p>1）乘客姓名必须与登机时所用证件上的名字一致；持护照登机的外宾，须按护照上的顺序填写且不区分大小写。</p>",' <p>2）姓名中包含生僻字或者繁体字，请从生僻字开始之后的中文都用拼音代替，如：王喆敏，请填写”王zhemin"</p>'," <p>3）姓名过长时请使用缩写，如：”买买提不拉多娜萨日娜阿诺凡“ 简写为 ”买买提不拉多娜萨日娜阿“</p>","</div>","</div>"].join("");a=$(a),pb||(pb=new Hb({html:a,closeDom:".flight-windows"})),pb.show()},orderDetailAction:function(a){var b=this.vPassenger.getTicketsCount(H),c=$(a.target).hasClass("j_btn");if(!B.isShowLoad&&!c&&(b[0]||b[1]||b[2])){var d=F.get(),e=F.getAttr("items"),f=N.getAttr("selInsure"),g=this.$el.find("#insure_detail"),h=!(32!=P.getAttr("type")||2!=P.getAttr("paytype")),i=F.getAttr("flightDetailsStore.setAttr"),j=S.getUser(),k={items:F.getAttr("items"),ticketsCnt:b,insurance:f&&d.insurances&&d.insurances.length?{amount:g.data("unitprice"),count:parseInt(g.data("pcount"))*parseInt(g.data("mininsure"))}:null,delivery:h?{amount:10,count:1}:null,coupon:null,reduce:null},l=function(a){$(a.target).hasClass("j_orderDetails")||(ob.elsBox.orderDetail.hide().html(""),$("#order-detail-mask").hide(),m.css("z-index",999),$(".j_orderDetails").removeClass("money-btn-detailon"))};N.getAttr("selCoupons")&&i&&+i>0&&j&&0==j.IsNonUser&&(+e[0].policy.rebateAmt>0||e.length>1&&+e[1].policy.rebateAmt>0)&&(k.coupon={amount:parseInt(e[0].policy.rebateAmt),count:k.ticketsCnt[0]},k.coupon+=e.length>1?parseInt(e[1].policy.rebateAmt):0),$("body").unbind("click",l).bind("click",l);var m=$("#paybtn"),n=parseInt(m.css("z-index"));this.elsBox.orderDetail.html()?(ob.elsBox.orderDetail.hide().html(""),$("#order-detail-mask").hide(),m.css("z-index",n-4e3),$(".j_orderDetails").removeClass("money-btn-detailon")):(this.elsBox.orderDetail.html(this.orderDetailtplfun(k)),this.elsBox.orderDetail.show(),$("#order-detail-mask").show(),m.css("z-index",n+4e3),$(".j_orderDetails").addClass("money-btn-detailon")),a.stopImmediatePropagation()}},showErrorTips:function(a,b,c,d){d="undefined"==typeof d?!1:d,a=a||DataControl.errorType,b=b||DataControl.errorMessage,c="undefined"==typeof c?"":c;var e=c?'li[data-id="'+c+'"] '+a:a;r.showTip(DataControl.tipIconType||DataControl.TIPICONS.RED,e,b,d)},hideErrorTips:function(a){a&&a.currentTarget?$(a.currentTarget).parent().find(".form-tips").hide():$(a).parent().find(".form-tips").hide()},touchStartAction:function(a){var b=a.changedTouches[0].pageY;$(a.currentTarget).bind("touchend",function(c){Math.abs(b-c.changedTouches[0].pageY)<=10&&($(a.currentTarget).focus(),$(a.currentTarget).unbind("touchend"))})},viewInsure:function(a){var b="#insuranceinfo!"+$(a.currentTarget).attr("data-typeid");ob.vInsurance.viewInsure(b)},selDelivery:function(){var a=F.get();return a?void this.forward("#zqInPickTicketSelect"):void this.showAlert()},switchInsure:function(a){var b=this,c=b.$el.find("#insure_detail"),d=c.find("em i"),e=a.getStatus()?1:0,f=H.getAttr("validSelCount");e&&+N.getAttr("selInsure")!=e?(c.data("pcount",f),d.html(c.data("pcount")*c.data("mininsure"))):e||+N.getAttr("selInsure")==e||d.html(0),N.setAttr("selInsure",e),this.updateOrderPrice(),Bb.setAttr("IsCancelInsurance",!e),this.vTravelPackages.togglePackageDesc(e)},renderList:function(a){var b=P.get(this.UserID)||{type:1},c=b.paytype,d=0,e=this.UserID,f=this.DelItemsData;f.length||(b={type:1},P.setAttr("type",1,ob.UserID));!function(a,c,e,f,g,h,i,j,k,l){if(j&&j.length){d=j[0]?j[0].exinfo.fee:d;var m=j.some(function(a){if(b.type==a.type&&a.exinfo&&a.exinfo.pays){a.exinfo.pays.length<2&&(!a.exinfo.pays[0]||a.exinfo.pays[0]&&0!=a.exinfo.pays[0].paytype)&&a.exinfo.pays.push({paytype:0,amount:0});var c=a.exinfo.pays.some(function(a){return(2==a.paytype||0==a.paytype)&&(d=j[0].exinfo.fee),a.paytype==b.paytype});c||(f.setAttr("paytype",l.getPayType(a.exinfo.pays)),b=f.get(l.UserID))}return b.type==a.type});m||(b={type:1},f.setAttr("type",1,l.UserID))}var n=+b.type,o=(2==n?g.get(l.UserID):16==n?h.get():null,{fee:32!=n||2!=b.paytype&&0!=b.paytype?0:d,sendFee:d,type:n});k.post=o,f.setAttr("deliveryInfo",o)}(H,N,Bb,P,Q,R,e,f,a,this);ob.vFlightInfo.renderList(a),ob.vInsurance.render(a);{var g=this.vVouchers.deliverytplfun,h=ob.vVouchers.deltabfun,i=ob.vVouchers.delcostfun;ob.increaseOrderPrice}this.vVouchers.renderInvoice(f,ob,n,a,b,g,c,P,S,Q,ib,yb,i,h,rb),this.vVouchers.updateInvoiceBox(nb,H,Db,S,F,N,ob);var j=N.get()||{},k=(function(a,b,c,d,e,f,g,h,i,k,l,m,n,o,p,q,r,s,t,u,v,w){if(16==e.type||1==a.length&&16==a[0].type?(e.type=16,b.$el.find("#invoice_switch").attr("data-type",16),b.vVouchers.updateZqAir(b,h,i,k,m,o,p,q,r)):a.length&&b.vVouchers.updateAddrList(s,t,u,l,v,w),j=j?j:{},4!=(4&+d.flag)){{new c.cuiSwitch({rootBox:b.$el.find("#insure_switch"),checked:j.selInsure?j.selInsure:!1,changed:function(){b.switchInsure(this)}})}d.insurances&&d.insurances.length&&j.selInsure?$("#package-desc a:nth-of-type(1)").show():$("#package-desc a:nth-of-type(1)").hide()}}(f,ob,n,a,b,g,c,m,W,db,P,E,H,F,hb,G,R,Q,S,bb,ib,ab,i),this.couponstplfun);this.QueryCustomerCoupon(S,H,N,F,ub,ob,k,a),ob.vTravelPackages.render(a,zb,H),a.hasTravalPackage?ob.$el.find("#package-desc").removeClass("js_hide"):"",this.elsBox.notice_box.html(this.noticetplfun(a)),a.payAmt=ob.vPayment.accountTotalPrice(),ob.elsBox.pay_box.html(ob.paytplfun(a)).show(),ob.$el.find("#flightBox").show(),Fb.getAttr("isCCB")&&(ob.$el.find("#js_flight-top").hide(),ob.$el.find(".flight-loginline-fixed").hide(),ob.$el.find(".flight-loginline").hide())},repeatAddrCheck:function(a,b,c,d,e,f){if(a.isLogin()){var g=a.isLogin()?b.get():c.get(),h="";h+=g.prvnName?g.prvnName+";":";",h+=g.ctyName?g.ctyName+";":";",h+=g.dstrName?g.dstrName:"",d.setParam({cname:h}),f.showLoading(),d.excute(function(a){f.hideLoading(),e(a.rc)},function(){f.hideLoading(),e(0)},!0,f)}else e(0)},getInsureOrLipingTotalPrice:function(a,b,c,d){{var e=a.get(),f=b.get(this.uid).pkgtype;c.get()}if(!e.ispackage||!e.pkglist.length)return 0;var g=e.pkglist.filter(function(a){return a.basicinfo.pkgtype==f});if(g.length){var h=g[0].packageinfo.psgs.filter(function(a){return 1==a.psgtype});return g[0].count=(h.length?+h[0].min:1)*d,g[0].count*+g[0].price}},QueryCustomerCoupon:function(a,b,c,d,e,f,g,h){if(a.isLogin()){var i=0,j=b.get();j&&j.passengers&&$.each(j.passengers,function(a,b){1==b.selected&&1==b.ticketType&&i++}),h.user||(h.user=T);var k=c.get()||{};h.order||(h.order=k),h.CRCount=i,e.excute(function(a){a.amt>=0&&(h.couponBalance=a.amt,d.setAttr("couponBalance",a.amt),f.renderCouponBox(h))},function(){h.couponBalance=0,d.setAttr("couponBalance",0),f.renderCouponBox(h)},!0,this)}},renderCouponBox:function(a){a&&a.couponBalance&&+a.couponBalance>0&&a.user&&0==a.user.IsNonUser&&(+a.items[0].policy.rebateAmt>0||a.items.length>1&&+a.items[1].policy.rebateAmt>0)?(ob.elsBox.coupons_box.html(ob.couponstplfun(a)),sb=new n.cuiSwitch({rootBox:ob.$el.find("#coupons_switch"),checked:!!(a.order&&a.order.selCoupons&&+a.order.selCoupons>0),changed:function(){ob.couponsSwitchAction(N,this)}})):ob.elsBox.coupons_box.html("")},showRebate:function(a){var b=$(a.currentTarget),c=b.attr("data-rbt"),d=b.attr("data-rbtType");if(c&&+c>0){var e=b.find("span.jsArrow");e.hasClass("sjTop")?(b.find("p.jsrbt"+d).show(),e.addClass("sjBottom"),e.removeClass("sjTop")):(b.find("p.jsrbt"+d).hide(),e.removeClass("sjBottom"),e.addClass("sjTop"))}},fanBoxAction:function(){if(!B.isShowLoad){var a=$(".j_refundPolicyTips").html();r.popUp(this.$el,a)}},tgBoxAction:function(a){if(!B.isShowLoad){var b=$(a.currentTarget),c=b.siblings(".flight-pnttips"),d=b.prev(".flight-rtntips");b.hasClass("flight-arrdown")?(d.hasClass("js_hide")||d.addClass("js_hide"),b.removeClass("flight-arrdown"),b.text("收起退改签"),b.addClass("flight-arrup"),c.show()):b.hasClass("flight-arrup")&&(b.text("查看退改签"),b.removeClass("flight-arrup"),b.addClass("flight-arrdown"),c.hide()),Bb.setAttr("IsCheckTGQ",!0)}},couponsSwitchAction:function(a,b){var c=0;flightOrderData=a.get(),flightOrderData=flightOrderData?flightOrderData:{},b.getStatus()&&(c=1),a.setAttr("selCoupons",c)},updateDelList:function(a,b,c){var d=this.vVouchers.PickTicketParam(b,c);d.polid=D.getParamStore().get().polid,eb.setParam(d),this.DelItemsData=[],eb.excute(function(b){this.DelItemsData=this.vVouchers.getCurrentItems(b),a&&a()},function(){rb&&(rb.changed=function(){ob.$el.find("#invoice_switch .cui-switch").removeClass("current"),ob.$el.find("#invoice_switch .cui-switch-bg").removeClass("current")});var b={deliveries:[]};this.DelItemsData=this.vVouchers.getCurrentItems(b),a&&a()},!1,this)},getPayType:function(a){return"undefined"==typeof a&&this.DelItemsData&&this.DelItemsData[0]&&this.DelItemsData[0].exinfo&&(a=this.DelItemsData[0].exinfo.pays||[]),a.length?a[0].paytype:0},getExInfoByPayType:function(a,b,c){var d=null;return c=c||a.getAttr("pays")||[],$(c).each(function(a,c){return c.paytype==b?(d=c,!1):void 0}),d},showDelListUI:function(a){var b=($(a.currentTarget),P.get(this.UserID)||{type:1}),c=0;if(!(this.DelItemsData.length<=1)){_.each(this.DelItemsData,function(a,d){a.type==b.type&&(c=d)});var d=new m.ui.ScrollRadioList({title:"配送方式",index:c,data:this.DelItemsData,itemClick:function(a){ob.$el.find(".js_del_tab span.flight-section-sp1").text(a.key);P.getAttr("type"),P.getAttr("deliveryInfo"),P.getAttr("paytype");P.setAttr("type",a.type,this.UserID),ob.trigger(ob.EVENTS.UPDATEORDERPRICE),ob.$el.find("#invoice_switch").data("type",a.type),16==a.type?(ob.vVouchers.updateZqAir(ob,m,W,db,E,F,hb,G,R),Q.setAttr("edit",0,this.UserID)):ob.vVouchers.updateAddrList(Q,S,bb,P,ib,ab),32!=a.type?($(".js_del_cost .flight-bxinfo-box").hide(),$("#gift-card-tips").hide()):($(".js_del_cost .flight-bxinfo-box").show(),$(".js_del_cost .flight-bxinfo-box").removeClass("js_hide"),$("#gift-card-tips").show())}});d.show()}},AddrListAction:function(){var a=u.CustomerAddrQueryModel.getInstance();cb.setCurrent(this.UserID,{success:"/webapp/flight/#bookinginfo",defeated:"/webapp/flight/#bookinginfo"},"CustomerAddrStore:setAddr","CustomerAddrStore:get"),S.isLogin()?a.excute(function(a){_.isArray(a.addrs)&&a.addrs.length?this.jump("/webapp/fpage/#addresslist"):(Q.setAttr("opr",1),Q.set(Q.get(),this.UserID),this.jump("/webapp/fpage/#addressinfo?from=bookinginfo"))},function(){Q.setAttr("opr",1),Q.set(Q.get(),this.UserID),this.jump("/webapp/fpage/#addressinfo")},!0,this):(Q.setAttr("opr",1),Q.set(Q.get(),this.UserID),this.jump("/webapp/fpage/#addressinfo?from=bookinginfo"))},selectCityAction:function(){function a(){this.hideLoading();var a=L.get(),c=a[0].citys,d=c[0].contries,e=a[0],f=function(a,b,c){var d=0;return _.each(c,function(c,e){return c[b]==a?(d=e,!1):void 0}),d},g=1,h=1,i=0;b.prvnId&&(g=f(b.prvnId,"treeKey",a),e=a[g],c=e.citys,h=f(b.ctyId,"treeKey",c),d=c[h].contries,i=f(b.dstrId,"treeKey",d)),a.forEach(function(a){a.key=a.prvn,a.value=a.name}),c.forEach(function(a){a.key=a.cty,a.value=a.name}),d.forEach(function(a){a.key=a.treeKey,a.value=a.name});var j=function(a){c=a.citys,d=a.citys[0].contries,m.updateScrollListByIndex(1,c),m.updateScrollListByIndex(2,d)},k=function(a){d=a.contries,m.updateScrollListByIndex(2,d)},l=function(){},m=new o({title:"选择所在地区",data:[a,c,d],index:[g,h,i],changed:[j,k,l],disItemNum:4,cancel:"取消",ok:"确定",okClick:function(a){$("#selectCity .flight-listsim3-table > span").html(a[0].name+""+a[1].name+a[2].name),Q.setAttr("prvnId",a[0].prvn,ob.UserID),Q.setAttr("prvnName",a[0].name,ob.UserID),Q.setAttr("ctyId",a[1].cty,ob.UserID),Q.setAttr("ctyName",a[1].name,ob.UserID),Q.setAttr("dstrId",a[2].id,ob.UserID),Q.setAttr("dstrName",a[2].name,ob.UserID)}.bind(this)});m.show()}var b=Q.get(this.UserID);ib.set({prvnId:b.prvnId,prvnName:b.prvnName,prvn:b.prvnName,ctyId:b.ctyId,ctyName:b.ctyName,cty:b.ctyName,dstrId:b.dstrId,dstrName:b.dstrName,dstr:b.dstrName},this.UserID);var c=this,d=L.get();d?a.call(this):(this.showLoading(),M.excute(function(b){L.set(b),a.call(c)},function(){this.showMessage("网络连接失败,请稍候重试"),this.hideLoading()},!0,this))},inTitleChangeWrp:function(){ob.vVouchers.inTitleChange(S,Db,N,r.hideTip)},showinTitleList:function(){S.isLogin()?(mb.setCurrent("invinfo.addr",{success:"/webapp/flight/#bookinginfo",defeated:"/webapp/flight/#bookinginfo"},"","","flight"),this.jump("/webapp/invoice/index.html#select?businesstype=flight")):(this.showLoading(),window.location.href="/webapp/myctrip/#account/login?t=1&from="+encodeURIComponent(this.getRoot()+"#bookinginfo"))},showCalendarUI:function(a,b,c){var d=a.getAttr("time");c.calendar=new b({date:{start:{title:function(a,b){return b(a)},value:d}},title:"取票日期",Months:6,callback:function(d){if(c.zqTimeObj.defaHourList=c.zqPrintDetail(c.zqTimeObj.validDate,d),c.zqTimeObj.defaHourList.length>0){var e=c.zqTimeObj.defaHourList[c.zqTimeObj.defaHourList.length-1];d.setHours(e.slice(0,2),e.slice(3))}a.setAttr("time",d.toString()),c.zqTimeObj.selectDate=d,c.vVouchers.updateZqAir(c,m,W,b,E,F,hb,G,a),c.$el.show(),this.hide(),window.scrollTo(0,c.scrollPosY)},onHide:function(){c.$el.show()},classNames:"calen-cls"})},showZqTimeUI:function(a){var b=($(a.currentTarget),0),c=[],d=m.base.Date.parse(ob.zqTimeObj.selectDate.toString()).format("H:i");_.each(this.zqTimeObj.defaHourList,function(a,e){c.push({key:e,val:a}),d==a&&(b=e)});var e=new m.ui.ScrollRadioList({title:"取票时间",index:b,data:c,itemClick:function(a){ob.zqTimeObj.selectDate.setHours(a.val.slice(0,2),a.val.slice(3)),ob.$el.find("#date-zqtime span").html(a.val),R.setAttr("time",ob.zqTimeObj.selectDate.toString(),this.citykey)}});e.show()},calendarAction:function(){(this.calendar||this.showCalendarUI(R,db,ob))&&(this.calendar.update({validStartDate:new Date(this.zqTimeObj.validDate[0][0]),validEndDate:new Date(this.zqTimeObj.validDate[this.zqTimeObj.validDate.length-1][1])}),this.scrollPosY=$(window).scrollTop(),window.scrollTo(0,0),this.$el.hide(),this.calendar.show())},zqinairselect:function(){this.forward("zqInAirportSelect")},zqPrintDetail:function(a,b){"string"==typeof b&&(b=new Date(b));var c,d=a.length,e=[],f=0,g=!0,h=b.getMonth();if(day=b.getDate(),!d)return e;for(;d>f;f++)for(var i=a[f],j=0,k=i.length;k>j;j++)if(i[j].getMonth()===h&&i[j].getDate()===day){c=i;break}if(!c)return e;var l=c[0],m=c[1],n=l.getTime(),o=m.getTime();for(m.getMinutes(),m.getHours();o>=n;){var p=new Date(n),q=p.getHours(),r=p.getMinutes();g&&(g=!1,r&&(p=new Date(r>30?n+=60*(60-r)*1e3:n+=60*(30-r)*1e3),q=p.getHours(),r=p.getMinutes())),n+=18e5,e.push((10>q?"0"+q:q)+":"+(r?r:"00"))}return e},setContact:function(a){var b=N.get();b=b?b:{};var c=b.contact?b.contact:{},d=$(a.currentTarget),e=d.val().trim();c.mphone=e,N.setAttr("contact",c)},viewCoupons:function(){var a=F.get();return a?void this.forward("#coupons"):(ob.hideLoading(),void this.showAlert())},beforePayAction:function(){try{this.vPassenger.setPassengersMDInfo()}catch(a){0}var b=F.get();if(b&&b.items&&b.items.length>1){var c=b.items[0].basicInfo.dTime,d=b.items[1].basicInfo.dTime;if(new Date(c)>=new Date(d))return void this.showAlert("不能提交返程比去程更早起飞的航班组合",!1)}var e=Q.get(S.isLogin()?this.UserID:""),f=P.getAttr("type");if(this.DelItemsData.length&&f&&(2==f||32==f)){if(!this.vVouchers.verifyAddrInput(r.showTip,Bb,e.recipient,e.addr,e.zip))return void Bb.increaseCntByKey("NextStepNotPassClick");S.isLogin()&&(gb.setParam(e),gb.excute(function(a){0},function(a){0}))}if(this.vPassenger.beforePayValidate()&&this.vPassenger.checkSupportCards(F,H,DataControl)&&this.vPassenger.checkMinPassenger(F,H)){if(F.get()&&F.get().needinv){var g=P.get(this.UserID)||{type:1};if(!(+g.type<=1)&&""==this.$el.find("#js_invoice_title").val())return r.showTip(DataControl.TIPICONS.RED,"#js_invoice_title","请填写发票抬头",!0),Bb.increaseCntByKey("NextStepNotPassClick"),!1}if(b.ispackage&&2==zb.getAttr("pkgtype",this.UserID)&&!S.isLogin())return void this.showAlert("会员才可以使用礼品卡，请先登录",!1);this.payAction()}else Bb.increaseCntByKey("NextStepNotPassClick")},sendUbt:function(){if(window.$_bf&&1==window.$_bf.loaded){var a=225001;"undefined"==typeof window.__bfi&&(window.__bfi=[]),window.__bfi.push(["_asynRefresh",{page_id:a,orderid:_orderID}]),window.$_bf.asynRefresh({page_id:a,orderid:_orderID})}else setTimeout($.proxy(this.sendUbt,this),300)},jumpToPaymentV2:function(a){var b=this;Eb.set(a);var c=function(a){for(var b="",c=0;a>c;c++)b+=Math.floor(10*Math.random());return b};if(0==a.rc){for(var d={},e=0;e<a.orders.length;e++){var f=a.orders[e];f.master&&1==f.master&&(d=f)}var g=d.oid,h=d.currency,i=a.amt||0,j=a.extno||"",k=(a.head.auth,c(19)),l={oid:g,bustype:"101",from:location.href,sback:location.origin+"/webapp/flight/#orderresults?rc=0&type=flight&orderid="+g,eback:location.origin+"/webapp/flight/#orderresults?rc=1&type=flight&orderid="+g,rback:location.origin+"/webapp/flight/#orderresults?rc=2&type=flight&orderid="+g,auth:S.getUser().Auth,title:"机票订单",currency:h,amount:i,extno:j,islogin:S.isNonUser()?1:0,requestid:k},m=P.get(this.UserID);1==a.needInvoice&&(l.needInvoice=a.needInvoice,l.invoiceDeliveryFee=32!=+m.type||0!=m.paytype&&2!=m.paytype?0:m.deliveryInfo.sendFee,l.includeInTotalPrice=!0);var n=y.Base64.encode(JSON.stringify(l)),o=location.host,p="https://secure.ctrip.com/webapp/payment2/index.html#index?";if(p=o.match(/^(localhost|172\.16|127\.0)/i)?"https://secure.fws.qa.nt.ctripcorp.com/webapp/payment2/index.html#index?":o.match(/^m.fat/i)||o.match(/^m.test/i)?"https://secure.fws.qa.nt.ctripcorp.com/webapp/payment2/index.html#index?":o.match(/^m\.uat\.qa/i)?"https://secure.uat.sh.ctriptravel.com/webapp/payment2/index.html#index?":o.match(/10.\8/gi)?"https://10.8.5.10/webapp/payment2/index.html#index?":"https://secure.ctrip.com/webapp/payment2/index.html#index?",p+="oid="+g+"&bustype=101&token="+n,Fb.getAttr("isCCB")){var q=Fb.get().osType,r=Fb.get().osVer,s={osType:q,osVersion:r,payWayWhiteList:"EB_CCB"},t=y.Base64.encode(JSON.stringify(s));
p+="&extend="+t}try{var u=a.orders[0].oid,v={};v.dcity=flightSearchData.items[0].dcityName,v.acity=flightSearchData.items[0].acityName,v.wanfan=1===flightSearchData.items.length?!1:!0,lb.set(v,u)}catch(w){0}J.remove(),K.getAttr("Edit")&&(K.remove(),H.remove()),R.remove(),b.jump(p)}else b.showToast("支付失败，请稍后再试")},checkMobileNumber:function(a){var b=this,c=$(a||"#linkTel").val().trim();return c.length<=0?(b.showErrorTips("#linkTel","请填写手机号码",void 0,!1),Bb.increaseCntByKey("NextStepNotPassClick"),!1):c.length<11?(b.showErrorTips("#linkTel","请填写正确的手机号码",void 0,!1),Bb.increaseCntByKey("NextStepNotPassClick"),!1):m.utility.validate.isMobile(c)?(b.hideErrorTips("#linkTel"),$("#linkTel").removeClass("highlight"),!0):(b.showErrorTips("#linkTel","请填写正确的手机号码",void 0,!1),Bb.increaseCntByKey("NextStepNotPassClick"),!1)},payAction:function(){var a,b,c=this,d=H.getAttr("selCount"),e=F.get(),f=G.get(),g=E.get();if(!(e&&e.items&&f&&f.depart&&g&&g.items))return c.hideLoading(),c.showAlert("对不起，由于您长时间未操作，订单已失效，请重新查询预订！"),void Bb.increaseCntByKey("NextStepNotPassClick");var h=S.getUser(),i=c.$el.find("#paybtn em.fs"),j=0,k=i.data("amt");if(!k||0>=+k)return c.showAlert("抱歉，您选择的价格舱位已售完，请重新查询选择其它价格舱位预订。",!1),void Bb.increaseCntByKey("NextStepNotPassClick");if(!c.checkMobileNumber())return!1;var l=(H.get(),c.vPassenger.savePassengers()),m=l.passengers,n=l.adultTicketCnt;d=l.pcount,a=N.getAttr("passengersinfo")||[];var o=_.compact(_.pluck(m,"name")),p=r.isRepeatName(o);if(p)return void c.showAlert("两名乘机人姓名相同："+p+"，请分2张订单提交",!1);var q="Flight/Domestic/Order/RepeatOrderCheck",s={};if(!c.isRepeatOrder&&S.isLogin()&&A[q]&&"function"==typeof A[q].mappingRequest&&(s=A[q].mappingRequest(m,e),s.timeout=300,wb.setParam(s),c.vOrder.fnCheckRepeatOrder()),(!S.isLogin()||c.isRepeatOrder)&&!this.vOrder.checkTicketAmount(m)){c.showLoading(!0);var t=N.get();t=t?t:{},t.selCoupons&&+t.selCoupons>0&&(j=$("#coupons_switch").attr("data-rbt"),N.setAttr("IsNeedFan",1)),b=t.contact?t.contact:{},b.mphone=$("#linkTel").val().trim(),N.setAttr("contact",b);var u=t.order?t.order:{};h&&h.Auth?(N.setAttr("auth",h.Auth),N.setAttr("IsNonUser",h.IsNonUser),N.setAttr("ugrade",h.VipGrade)):(N.setAttr("auth",""),N.setAttr("IsNonUser",!0),N.setAttr("ugrade",0),N.setAttr("RebateAmount",0),N.setAttr("IsNeedFan",0),j=0);var t=N.get(),v=[],w=c.getQuery("snno");N.setAttr("preBookExt",w),N.setAttr("AllianceID",""),N.setAttr("SID",""),N.setAttr("OUID",""),u.oid="",u.price=k,u.payType=1,u.issue=!0,u.rebateAmt=j,u.flag=e.flag;var x=P.get(c.UserID)||{type:1};u.deliveryType=x.type,N.setAttr("order",u);var y=c.vInsurance.getBxQty(),z=c.vInsurance.getSels(),B=+t.selInsure>0?+t.selInsure:z,C=+B>0;if(C&&e.insurances&&e.insurances.length>0&&y&&+y>0){c.vInsurance.setInsuranceIntoFlightOrderStore(y);var D,v=[],I=1,f=G.get();if(D={no:e.items[0].basicInfo.flightNo,"class":e.items[0].policy.class,subclass:e.items[0].policy.subclass,dCtyCode:e.items[0].basicInfo.dCtyCode,dCtyId:e.items[0].basicInfo.dCtyId,aCtyCode:e.items[0].basicInfo.aCtyCode,aCtyId:e.items[0].basicInfo.aCtyId,dPortCode:e.items[0].basicInfo.dPortCode,aPortCode:e.items[0].basicInfo.aPortCode,dDate:e.items[0].basicInfo.dTime,aDate:e.items[0].basicInfo.aTime,ext:e.items[0].ext,price:e.items[0].policy.price,productType:e.items[0].policy.productType},v.push(D),f.arrive&&e.items.length>1&&f.arrive.cabin&&g.tripType&&+g.tripType>1){I=2;var J={no:e.items[1].basicInfo.flightNo,"class":e.items[1].policy.class,subclass:e.items[1].policy.subclass,dCtyCode:e.items[1].basicInfo.dCtyCode,dCtyId:e.items[1].basicInfo.dCtyId,aCtyCode:e.items[1].basicInfo.aCtyCode,aCtyId:e.items[1].basicInfo.aCtyId,dPortCode:e.items[1].basicInfo.dPortCode,aPortCode:e.items[1].basicInfo.aPortCode,dDate:e.items[1].basicInfo.dTime,aDate:e.items[1].basicInfo.aTime,ext:e.items[1].ext,price:e.items[1].policy.price,productType:e.items[1].policy.productType};v.push(J)}if(N.setAttr("flightInfos",v),N.setAttr("tripType",I),N.setAttr("passengers",m),a&&N.setAttr("passengersinfo",a),1!=+u.deliveryType){var K=2==+u.deliveryType?Q.get():16==+u.deliveryType?R.get():null,L={};if(L.ticketIssueCty=e.items[0].basicInfo.dCtyCode,L.date=D.dDate,K){if(2==+u.deliveryType&&(L.dstr=K.dstrId,L.addrId=K.inforId,L.addr=K.addr,L.fee=K.sndFee&&+K.sndFee>0?+K.sndFee:0,L.bspet={recipient:K.recipient,prvn:K.prvnName,cty:K.ctyName,dstr:K.dstrName,zip:K.zip}),16==+u.deliveryType){L.site=K.site;var M=new Date(K.time),T=W.Date.format(M,"Y-m-d  H:i:s");L.date=T,L.port=K.port,L.fee=K.fee&&+K.fee>0?+K.fee:0,L.dstr=K.dstr,L.addrId=K.id,L.addr=K.name}32==+u.deliveryType&&(L.fee=K.fee&&+K.fee>0?+K.fee:0,L.dstr=K.dstr,L.addrId=K.id,L.addr=K.name,L.bspet={recipient:K.recipient,prvn:K.prvnName,cty:K.ctyName,dstr:K.dstrName,zip:K.zip})}N.setAttr("delivery",L)}else N.removeAttr("delivery")}else N.removeAttr("delivery");var X=U.get(),Y=V.get();X&&X.sid?N.setAttr("sourceId",X.sid):N.setAttr("sourceId",""),Y&&Y.AllianceID&&Y.SID&&(N.setAttr("AllianceID",Y.AllianceID),N.setAttr("OUID",Y.OUID),N.setAttr("SID",Y.SID)),O.setParamStore(N);{N.get()}k=c.vPayment.accountTotalPrice();var Z=c.getOrderCreateParam(k,d,y);k=Z.oinfo.price,h=S.getUser();try{var ab=Q.get(c.UserID);""!==ab.prvnName&&Bb.setAttr("IsDeliveryArea",!0),c.widgetHidden.mdSubmit()}catch(bb){0}S.isLogin()?c.orderCreate(Z,k,n):$.ajax({url:"/html5/Account/NonUserLogin",data:b.mphone,type:"post",dataType:"json",timeout:2e5,success:function(a){a&&1==+a.ServerCode?(1==a.Data.IsNonUser&&(a.Data.LoginToken=""),S.removeUser(),S.setUser({UserID:a.Data.UserID,IsNonUser:!0,LoginToken:"",LoginName:null,Auth:a.Data.Auth,ExpiredTime:null}),c.orderCreate(Z,k,n)):(c.hideLoading(),c.showAlert("提交订单失败，请重新提交！",!1))},error:function(){c.hideLoading(),c.showAlert("提交订单失败，请重新提交！",!1)}})}},orderCreate:function(a,b,c){tb.setParam(a);var d=F.get(),e=a.oinfo.triptype;tb.excute(function(a){ob.hideLoading(),0,a.dcityName=d.items[0].basicInfo.dcname,a.acityName=d.items[0].basicInfo.acname;var f=P.get(this.UserID)||{type:1};if(a.needInvoice=1!=f.type,a.isK=d.items[0].basicInfo.IsK||!1,d.items.length>1&&(a.isK=a.isK||(d.items[1].basicInfo.IsK?d.items[1].basicInfo.IsK:!1)),a.tripType=e,0==a.rc){try{for(var g={},h=0;h<a.orders.length;h++){var i=a.orders[h];i.master&&1==i.master&&(g=i)}var j=g.oid;_orderID=j,this.sendUbt()}catch(k){}if(2==a.patarc){var l="<strong>航司实时价格调整确认</strong></br>",m="";if(1==e){var o=d.items[0].policy.price;m=ob.vPayment[ob.vPayment.EVENTS.FORMATPATAMESSAGE](a.priinfos[0].chapri,o,""),m&&(b+=(a.priinfos[0].chapri-o)*c)}else for(var h=0;h<a.priinfos.length;h++){var p=a.priinfos[h],o=d.items[p.segno-1].policy.price,p=a.priinfos[h],q="";q=1==p.segno?ob.vPayment[ob.vPayment.EVENTS.FORMATPATAMESSAGE](a.priinfos[h].chapri,o,"第一程"):ob.vPayment[ob.vPayment.EVENTS.FORMATPATAMESSAGE](a.priinfos[h].chapri,o,"第二程"),q&&(m+=q,b+=(a.priinfos[h].chapri-o)*c)}a.amt=b,m&&(m=l+m+"<strong >调整后订单总额：&yen;"+b+"</strong>",ob.alert=new n.Alert({title:"提示信息",message:m,buttons:[{text:"不接受",click:function(){E.setAttr("fullCabin",!0),this.hide(),ob.back("list")}},{text:"接受",click:function(){this.hide(),ob.jumpToPaymentV2(a)}}]}),ob.alert.show())}else a.amt=b,ob.jumpToPaymentV2(a)}else 1==a.rc&&ob.showToast(a.rmsg)},function(a){ob.hideLoading(),1005==+a.head.errcode?ob.showAlert("用户信息已过期，请重新登录！",!1):ob.showAlert(a.rmsg||a.msg,!1),0},!1,this)},getOrderCreateParam:function(a,b){var c={ver:0,hver:"",optype:0,oinfo:{},segs:[],prices:[],prolst:[],pkglst:[],needinvoice:!1,invoices:[],continfo:{},delinfo:{},psgs:[],psgsettings:[],misc:{pos:{ctype:3,lati:31.22013,longi:121.358315}}},d=$("#ab_testing_tracker").val();try{c.hver="v2.4.8-"+(d?d.split(":")[d.split(":").length-1].substring(0,1):"")}catch(e){c.hver="v2.4.8"}var f=H.get(),g=0;f&&f.passengers&&$.each(f.passengers,function(a,b){1==b.selected&&1==b.ticketType&&g++});var h=F.get(),i=h.originData,j=G.get(),k=E.get();c.oinfo.triptype=j.arrive&&h.items.length>1&&j.arrive.cabin&&k.tripType&&+k.tripType>1?2:1,c.oinfo.annoy=S.isLogin()?!1:!0,c.oinfo.chkno=i.pols[0].chkno,c.oinfo.price=a,segs_orderCreate={segno:0,prdid:i.prdid,polid:""};for(var l=(zb.get(this.uid).pkgtype,null),n=0,o=0;o<i.segs.length;o++){var p=(i.segs[o],i.pols[o]);0==o&&(segs_orderCreate.polid=p.polid);for(var q=p.prices,s=0;s<q.length;s++){var t=q[s];c.prices.push({segno:o+1,psgtype:t.psgtype,price:t.price,fuel:t.fuel,tax:t.tax})}for(var u=p.promos,v=0;v<u.length;v++){var w=u[v],x=0,y=w.price;if(!(w.promotype>5))if(1==w.promotype){if(!N.getAttr("selCoupons")||0>=g)break;y=h.items[o].policy.rebateAmt,n+=g*y,l={promoctgy:w.promoctgy,promoid:w.promoid,promotype:w.promotype,currency:w.currency,price:0,cnt:1,amount:0}}else{x=b;var z=x*y;c.prolst.push({promoctgy:w.promoctgy,promoid:w.promoid,promotype:w.promotype,currency:w.currency,price:y,cnt:x,amount:z})}}0==o&&(c=ob.vTravelPackages.setPaymentParam(p,c))}if(null!=l&&(+h.couponBalance<n&&(n=+h.couponBalance||0),l.price=n,l.amount=n,c.prolst.push(l)),c.needinvoice=h.needinv,c.needinvoice){var A=S.isLogin()?S.getUser().UserID:this.UserID,B=Db.getAttr(A),C="";B&&(C=B.title);var D=Db.getAttr("invoiceinfo",A)||{};c.invoices=[{invtype:D.intype?+D.intype:1,title:C,body:""}]}var I=N.get()||{},J=V.get();J&&J.AllianceID>0&&J.SID>0&&(c.misc.allianceInfo={},c.misc.allianceInfo.id=I.AllianceID,c.misc.allianceInfo.ouid=I.OUID||"",c.misc.allianceInfo.sid=I.SID),c.continfo.name=null,I.contact&&(c.continfo.phone=I.contact.mphone);var K=P.get(this.UserID)||{type:1};if(c.delinfo.delvtype=K.type,32==K.type){var L=P.getAttr("paytype"),M=ob.getExInfoByPayType(P,L),O=K.deliveryInfo.fee||K.deliveryInfo.sendFee;(2==L||0==L)&&(c.delinfo.fee=O),c.delinfo.extinfo={paytype:-1==L?2:L,amount:-1==L?0:M.amount}}else c.delinfo.extinfo=null;if(1!=K.type){var T=2==+K.type||32==+K.type?Q.get(this.UserID):16==+K.type?R.get():null;if(T&&((2==+K.type||32==+K.type)&&(c.delinfo.sendadd={recver:T.recipient,phone:c.continfo.phone,province:T.prvnName,city:T.ctyName,zone:T.dstrName,addr:T.addr,post:T.zip}),16==+K.type)){var U=new Date(T.time),X=W.Date.format(U,"Y-m-d  H:i:s");c.delinfo.delvadd={siteid:T.id,ssiteid:T.site,addr:T.name},c.delinfo.senddate=X}}for(var o in f.passengers){var Y=f.passengers[o];if(1==+Y.selected){var Z=null;Z=1==+Y.defaIdCard.type?m.base.Date.parse(r.getBirth(Y.defaIdCard.no)).format("Y-m-d"):m.base.Date.parse(Y.birth).format("Y-m-d"),c.psgs.push({psgid:Y.inforId.toString().substr(0,9),psgname:"CN"==Y.language?Y.cname:Y.ename,psgnamen:Y.ename,psgtype:DataControl.getPsgType(0,Y),birth:Z,cnum:Y.defaIdCard.no,ctype:Y.defaIdCard.type,gender:Y.gender,nation:Y.natl,ffpinfo:[]}),c.psgsettings.push({segno:0,psgid:Y.inforId.toString().substr(0,9),tkttype:Y.ticketType>0?Y.ticketType:1})}}return c.segs.push(segs_orderCreate),c},telInputFinish:function(a){var b=$.trim($(a.target).val());this.checkMobileNumber(a.target),""===b?Bb.setAttr("IsContactPhone",!1):Bb.setAttr("IsContactPhone",!0),Bb.setAttr("ContactPhonePass",!!m.utility.validate.isMobile(b))},updateTotalPrice:function(a,b){this.vPayment[this.vPayment.EVENTS.UPDATETOTALPRICE](a,b)},packageSelect:function(){{var a=this;!function(a,b){var c=a.get();return c?void b.forward("packageselect"):(b.hideLoading(),void b.showAlert())}(F,a)}},showAlert:function(a,b){b="undefined"==typeof b?!0:b,this.alert=new n.Alert({title:"提示信息",message:a?a:"对不起，由于您长时间未操作，订单已失效，请重新查询预订！",buttons:[{text:"知道了",click:function(){b&&(ob.backAction(1),ob.hideLoading()),this.hide()}}]}),this.alert.show()},showLoading:function(a){B.isShowLoad=!0,Gb.show(),a&&(qb=qb||new Hb,qb.show())},hideLoading:function(a){Gb.hide(),B.isShowLoad=!1,a&&qb?qb.hide():""}}),B.isShowLoad=!1,B});