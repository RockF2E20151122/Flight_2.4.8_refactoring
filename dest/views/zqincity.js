define(["libs","c","FlightModel","FlightStore","CommonStore",buildViewTemplatesPath("zqincity.html"),"cWidgetFactory","cWidgetCalendar"],function(a,b,c,d,e,f,g){var h=b.base,i=8,j=g.create("Calendar"),k=b.view.extend({flightSearchStore:d.FlightSearchStore.getInstance(),curModel:c.zqInCityModel.getInstance(),flightStore:d.zqInCityStore.getInstance(),flightSelectedStore:d.FlightSelectedInfo.getInstance(),selectCityStore:d.zqInCitySelectStore.getInstance(),dateStorage:d.zqInCityDateStore.getInstance(),LastInCitySelectDateTime:d.LastInCitySelectDateTime.getInstance(),zqInCityDateAndAddressStore:d.zqInCityDateAndAddressStore.getInstance(),flightPickTicketSelectStore:d.FlightPickTicketSelectStore.getInstance(),userStore:e.UserStore.getInstance(),flightDetailModel:c.FlightDetailModel.getInstance(),tpl:f,pageid:"214038",minutes:0,minutes1:0,flightid:null,realStartDate:null,render:function(){this.$el.html(this.tpl),this.els={}},events:{"click .deduct-time":"deductTime","click .plus-time":"plusTime","click #finished":"finished","click #self-pickup-addr":"selfPickupAddr","click #picker-date":"pickerDate","click #js_return":"goBack"},goBack:function(){this.selectCityStore.remove(),this.dateStorage.remove(),this.$el.find("#address,#inCityDate,.hours").text(""),this.back("zqinpickticketselect")},selfPickupAddr:function(){this.forward("zqincityselect")},finished:function(){if(!(this.selectCityStore.get()&&this.selectCityStore.get().address&&this.LastInCitySelectDateTime.get()&&this.LastInCitySelectDateTime.get().times))return void this.showMessage("请填写自取地址");var a=this;this.zqInCityDateAndAddressStore.set({time:a.LastInCitySelectDateTime.get().times,zqInfo:a.selectCityStore.get()},this.flightCode),this.flightPickTicketSelectStore.setAttr("type",i),this.forward("bookinginfo")},getfinishedTime:function(){if(this.zqInCityDateAndAddressStore.get()&&this.zqInCityDateAndAddressStore.get().time){var a=new Date(this.zqInCityDateAndAddressStore.get().time),b=h.Date.format(a,"Y-m-d");this.$el.find("#inCityDate").text(b),this.$el.find(".hours").text(this.formatTimes(a.getHours())+":"+this.formatTimes(a.getMinutes()))}},createCalendar:function(){var a=this.getServerDate(),b=new h.Date(this.getServerDate()).addDay(5).valueOf(),c=this;this.calendar=new j({date:{start:{title:function(a,b){return b(a)},value:this.getServerDate()}},title:"取票日期",Months:2,callback:function(a){var b=new Date(a);c.dateStorage.set({date:b.valueOf()}),this.hide(),c.initSelectDate(c.getServerDate(),c.airTakeOff)},classNames:"calen-cls",validStartDate:a,validEndDate:b})},initSelectDate:function(a,b){if(this.dateStorage&&this.dateStorage.get()&&this.dutyEtime&&this.selectCityStore.get()){var c=new Date(this.dateStorage.get().date),d=new Date(this.dateStorage.get().date),e=new Date(this.dateStorage.get().date),f=new Date(a),g=new Date(a),i=new Date(a),j=new Date(a),k=new Date(a),l=new Date(b);this.$el.find(".room_num i").removeClass("num_invalid");var m=this.dutyEtime.substr(0,2),n=this.dutyEtime.substr(2,4),o=this.dutyBtime.substr(0,2),p=this.dutyBtime.substr(2,4);if(e.setHours(0,0,0,0),g.setHours(0,0,0,0),c.setHours(o,p,0,0),d.setHours(m,n,0,0),i.setHours(o,p,0,0),j.setHours(m,n,0,0),l.setHours(l.getHours()-2),k.setHours(k.getHours()+1),e.valueOf()==g.valueOf()&&k>=c&&d>=k&&l>k){var q=new Date(k),r=h.Date.format(q,"Y-m-d");this.$el.find("#inCityDate").text(r);var s=1==k.getHours().toString().length?"0"+k.getHours():k.getHours(),t=1==k.getMinutes().toString().length?"0"+k.getMinutes():k.getMinutes();this.$el.find(".hours").text(s+":"+t),this.LastInCitySelectDateTime.set({times:f.valueOf()},this.flightCode)}else{if(!(c>=k&&l>=c))return this.$el.find("#inCityDate").text("无效日期"),this.$el.find(".hours").text("无效"),void this.LastInCitySelectDateTime.set({times:!1},this.flightCode);var q=new Date(c),r=h.Date.format(q,"Y-m-d");this.$el.find("#inCityDate").text(r);var s=1==c.getHours().toString().length?"0"+c.getHours():c.getHours(),t=1==c.getMinutes().toString().length?"0"+c.getMinutes():c.getMinutes();this.$el.find(".hours").text(s+":"+t),this.LastInCitySelectDateTime.set({times:c.valueOf()},this.flightCode)}}else{var u=this;window.setTimeout(function(){u.showMessage("请先选择取票地址!")},100)}},formatTimes:function(a){return a>=10?a:"0"+a},initTimes:function(a,b){if(this.$el.find(".room_num i").removeClass("num_invalid"),this.dateStorage&&this.dateStorage.get()&&this.dutyEtime&&this.selectCityStore.get()){var c=new Date(this.dateStorage.get().date),d=new Date(this.dateStorage.get().date),e=new Date(this.dateStorage.get().date),f=(new Date(a),new Date(a)),g=new Date(a),i=new Date(a),j=new Date(a),k=new Date(b),l=this.dutyEtime.substr(0,2),m=this.dutyEtime.substr(2,4),n=this.dutyBtime.substr(0,2),o=this.dutyBtime.substr(2,4);e.setHours(0,0,0,0),f.setHours(0,0,0,0),c.setHours(n,o,0,0),d.setHours(l,m,0,0),g.setHours(n,o,0,0),i.setHours(l,m,0,0),k.setHours(k.getHours()-2),j.setHours(j.getHours()+1);var p=this.LastInCitySelectDateTime.get(this.flightCode),q=this.rdate=this.buildValidDate(a,k,{start:this.dutyBtime,end:this.dutyEtime}),r=this.buildValidTime(new Date(q.end.valueOf()),{start:this.dutyBtime,end:this.dutyEtime});if(k.valueOf()<r.start&&(this.rdate.end=new Date(this.rdate.end.valueOf()-864e5)),p&&p.times){var s=new Date(q.end.valueOf());if(s.setHours(23,59,59,59),p.times>=q.start&&p.times<=s)var t=this.rtime=this.buildValidTime(new Date(p.times),{start:this.dutyBtime,end:this.dutyEtime})}if(t&&this.LastInCitySelectDateTime.get(this.flightCode)&&this.LastInCitySelectDateTime.get().times&&this.LastInCitySelectDateTime.get().times>=t.start&&this.LastInCitySelectDateTime.get().times<=t.end){var u=new Date(this.LastInCitySelectDateTime.get().times),v=h.Date.format(u,"Y-m-d");this.$el.find("#inCityDate").text(v),this.$el.find(".hours").text(this.formatTimes(u.getHours())+":"+this.formatTimes(u.getMinutes()))}else if(this.zqInCityDateAndAddressStore.get(this.flightCode)&&this.zqInCityDateAndAddressStore.get(this.flightCode).time){var u=new Date(this.zqInCityDateAndAddressStore.get().time),v=h.Date.format(u,"Y-m-d");this.$el.find("#inCityDate").text(v),this.$el.find(".hours").text(this.formatTimes(u.getHours())+":"+this.formatTimes(u.getMinutes())),this.LastInCitySelectDateTime.set({times:this.zqInCityDateAndAddressStore.get().time},this.flightCode)}else if(e.valueOf()==f.valueOf()&&j>=c&&d>=j&&k>j||e.valueOf()!=f.valueOf()&&k>=i&&j>=g&&i>=j){var u=new Date(j),v=h.Date.format(u,"Y-m-d");this.$el.find("#inCityDate").text(v),this.$el.find(".hours").text(this.formatTimes(j.getHours())+":"+this.formatTimes(j.getMinutes())),this.LastInCitySelectDateTime.set({times:j.valueOf()},this.flightCode)}else{if(!(this.compareOrderAirLeaveTime>0))return this.$el.find("#inCityDate").text("无效日期"),this.$el.find(".hours").text("无效"),void this.LastInCitySelectDateTime.set({times:!1},this.flightCode);for(var w=1;w<=this.compareOrderAirLeaveTime;w++){if(c.setDate(c.getDate()+w),d.setDate(d.getDate()+w),c.setHours(n,o,0,0),d.setHours(l,m,0,0),c>=j&&d>j&&d>k&&k>=j||c>=j&&k>=j&&k>=d){var u=new Date(c),v=h.Date.format(u,"Y-m-d");return this.$el.find("#inCityDate").text(v),this.$el.find(".hours").text(this.formatTimes(c.getHours())+":"+this.formatTimes(c.getMinutes())),void this.LastInCitySelectDateTime.set({times:c.valueOf()},this.flightCode)}if(c>j&&k>=j&&d>=j&&k>=d){var u=new Date(d),v=h.Date.format(u,"Y-m-d");return this.$el.find("#inCityDate").text(v),this.$el.find(".hours").text(this.formatTimes(d.getHours())+":"+this.formatTimes(d.getMinutes())),void this.LastInCitySelectDateTime.set({times:d.valueOf()},this.flightCode)}return this.$el.find("#inCityDate").text("无效日期"),this.$el.find(".hours").text("无效"),void this.LastInCitySelectDateTime.set({times:!1},this.flightCode)}}}},storgeDeal:function(a){this.flightDetailModel.excute(function(b){var c=this.selectCityStore.get(this.flightCode),d=this.flightSelectedStore.get().depart;if(this.flightCode=d.flight.flightNo+d.cabin.price,c){var e=b&&b.insurances[0]&&b.insurances[0].sites&&b.insurances[0].sites.indexOf(c.site)>=0,f=this;this.dutyBtime=$.trim(this.selectCityStore.get().btime),this.dutyEtime=$.trim(this.selectCityStore.get().etime),this.$el.find("#address").text(f.selectCityStore.get().address+(e?"":" (不支持保险)"))}else{var g=this.zqInCityDateAndAddressStore.get(this.flightCode);g&&g.zqInfo&&(this.selectCityStore.set(g.zqInfo,this.flightCode),this.LastInCitySelectDateTime.set({times:g.time},this.flightCode),this.dutyBtime=$.trim(this.selectCityStore.get().btime),this.dutyEtime=$.trim(this.selectCityStore.get().etime),this.$el.find("#address").text(this.selectCityStore.get().address+(e?"":" (不支持保险)")))}a.call(this)},function(){this.forward("list")},!1,this)},pickerDate:function(){var a=this.LastInCitySelectDateTime.get(this.flightCode);a&&this.calendar.setDate({start:new Date(a.times)}),this.calendar.show()},updateSelectDate:function(a){{var b=this.getServerDate(),c=(this.realStartDate||b,new h.Date(b).addDay(a).valueOf(),this.calendar.getDate());c.start}this.calendar.update({validStartDate:this.rdate.start,validEndDate:this.rdate.end})},plusTime:function(a){if(this.LastInCitySelectDateTime.get(this.flightCode)&&this.LastInCitySelectDateTime.get().times&&this.dutyEtime){var b=new Date(this.LastInCitySelectDateTime.get().times),c=new Date(this.LastInCitySelectDateTime.get().times),d=new Date(this.LastInCitySelectDateTime.get().times),e=(new Date(this.LastInCitySelectDateTime.get().times),new Date(this.getServerDate()),new Date(this.airTakeOff)),f=this.dutyEtime.substr(0,2),g=this.dutyEtime.substr(2,4),i=this.dutyBtime.substr(0,2),j=this.dutyBtime.substr(2,4);if(b.setHours(i,j,0,0),c.setHours(f,g,0,0),e.setHours(e.getHours()-2),d.setMinutes(d.getMinutes()+30),c>=d&&e>d){var k=new Date(d),l=h.Date.format(k,"Y-m-d");this.$el.find("#inCityDate").text(l);var m=1==d.getHours().toString().length?"0"+d.getHours():d.getHours(),n=1==d.getMinutes().toString().length?"0"+d.getMinutes():d.getMinutes();this.$el.find(".hours").text(m+":"+n),this.$el.find(".deduct-time").removeClass("num_invalid"),this.LastInCitySelectDateTime.set({times:d.valueOf()},this.flightCode)}else $(a.currentTarget).addClass("num_invalid")}},deductTime:function(a){if(this.LastInCitySelectDateTime.get(this.flightCode)&&this.LastInCitySelectDateTime.get().times&&this.dutyEtime){var b=new Date(this.LastInCitySelectDateTime.get().times),c=new Date(this.LastInCitySelectDateTime.get().times),d=new Date(this.LastInCitySelectDateTime.get().times),e=(new Date(this.LastInCitySelectDateTime.get().times),new Date(this.getServerDate())),f=new Date(this.airTakeOff),g=this.dutyEtime.substr(0,2),i=this.dutyEtime.substr(2,4),j=this.dutyBtime.substr(0,2),k=this.dutyBtime.substr(2,4);if(b.setHours(j,k,0,0),c.setHours(g,i,0,0),e.getHours(),f.setHours(f.getHours()-2),d.setMinutes(d.getMinutes()-30),d>=e&&d>=b&&f>d){var l=new Date(d),m=h.Date.format(l,"Y-m-d");this.$el.find("#inCityDate").text(m),this.$el.find(".plus-time").removeClass("num_invalid");var n=1==d.getHours().toString().length?"0"+d.getHours():d.getHours(),o=1==d.getMinutes().toString().length?"0"+d.getMinutes():d.getMinutes();this.$el.find(".hours").text(n+":"+o),this.LastInCitySelectDateTime.set({times:d.valueOf()},this.flightCode)}else $(a.currentTarget).addClass("num_invalid")}},initAvailableDate:function(){if(this.dateStorage&&this.dateStorage.get()){{var a=this.dateStorage.get().date,b=new Date(a),c=new Date(this.airTakeOff);this.dutyEtime.substr(0,2),this.dutyEtime.substr(2,4)}c.setHours(0,0,0,0),b.setHours(0,0,0,0),this.compareOrderAirLeaveTime=(c-b)/864e5,this.compareOrderAirLeaveTime>=0&&this.updateSelectDate(this.compareOrderAirLeaveTime)}},initAvailableDate2:function(){if(this.dateStorage&&this.dateStorage.get()){var a=this.dateStorage.get().date,b=new Date(a),c=new Date(this.airTakeOff);c.setHours(0,0,0,0),b.setHours(0,0,0,0),this.compareOrderAirLeaveTime=(c-b)/864e5}},onCreate:function(){this.render(),this.createCalendar()},onLoad:function(){if(!this.flightSelectedStore.get()||!this.flightSelectedStore.get().depart){this.showMessage("已超时,请重新选择航班");var a=this;return void window.setTimeout(function(){a.back("list")},2e3)}var a=this;this.airTakeOff=new Date(h.Date.parse(a.flightSelectedStore.get().depart.flight.dTime,!0));var b=new Date(this.getServerDate()),c=b.valueOf();this.dateStorage.set({date:c}),this.initAvailableDate2(),this.turning(),this.storgeDeal($.proxy(function(){this.initTimes(this.getServerDate(),this.airTakeOff),this.dutyBtime&&this.initAvailableDate()},this))},onShow:function(){},onHide:function(){},buildValidTime:function(a,b){var c=$.trim(b.start).substr(0,2),d=$.trim(b.start).substr(3,2),e=$.trim(b.end).substr(0,2),f=$.trim(b.end).substr(3,2),g=new Date(a.valueOf()),h=new Date(a.valueOf()),i=36e5;return g.setHours(c,d,0,0),h.setHours(e,f,0,0),{start:g,end:h,now:new Date((a>g?a:g).valueOf()),def:new Date((a>g?a:g).valueOf()+i)}},buildValidDate:function(a,b,c){a=new Date(a.valueOf()),b=new Date(b.valueOf());var d=this.buildValidTime(a,c),e=36e5;a.valueOf()+e<d.start?(a=new Date(d.start.valueOf()),a.setHours(8,0,0,0)):a.valueOf()+e>d.end&&(a=new Date(d.end.valueOf()+24*e)),a.valueOf()>b.valueOf()-2*e&&(a=new Date(b.valueOf()-2*e));this.buildValidTime(a,c);return a.setHours(0,0,0,0),b.setHours(0,0,0,0),{start:a,end:b}}});return k});