define(["cSales","libs","c","CommonStore","FlightStore","FlightModel","cBasePageView",buildViewTemplatesPath("flightorderdetail.html"),"cUtilityCrypt","utility/utility.js","cUtility","cWidgetFactory","cWidgetGuider"],function(a,b,c,d,e,f,g,h,j,k,l){var m=c.ui,n=c.base,o=d.SalesObjectStore.getInstance(),p=e.FlightOrderParamStore.getInstance(),q=(e.FlightAircraftStore.getInstance(),f.FlightAircraftModel.getInstance()),r=e.FlightOrderDetailStore.getInstance(),s=(e.FlightOrderInfoStore.getInstance(),e.FlightPickTicketSelectStore.getInstance(),e.FlightTicketChangeForm.getInstance()),t=e.FlightTicketRefundFormStore.getInstance(),u=f.FlightOrderDetailModel.getInstance(),v=f.OrderCancelModel.getInstance(),w=f.ExpressStatusSearchModel.getInstance(),x=f.XiaoMiModel.getInstance(),y=f.PaymentThirdPartySignatureForFlightSearch.getInstance(),z=e.CancelCheckResultStore.getInstance(),A=0,B=d.UserStore.getInstance(),C=B.getUser(),D=(d.HeadStore.getInstance(),{amt:0,statusRmk:"&nbsp;"}),E=e.FlightCCBStore.getInstance(),F=g.extend({pageid:"214208",tpl:h,hasAd:!0,removeOrderStore:!0,tripType:null,homeUrl:"/html5",backUrl:"flightorderlist",getAppUrl:function(){var a="";if(A=this.getQuery("oid"),B&&B.getUser()){var b="";if(window.localStorage&&null!=window.localStorage.getItem("SALES")&&""!=window.localStorage.getItem("SALES")){var c=JSON.parse(window.localStorage.getItem("SALES"));null!=c.data&&(b=c.data.sourceid)}var d=u.getParam("id");a="/InlandFlightOrder?orderId="+d+"&UserID="+B.getUser().LoginName+"&extendSourceID="+b}return a},render:function(){this.$el.html(this.tpl),this.elsBox={flight_info_tpl:this.$el.find("#flight_info_tpl"),flight_info_box:this.$el.find("#flight_info_box"),flight_fly_tpl:this.$el.find("#flight_fly_tpl"),flight_fly_box:this.$el.find("#flight_fly_box"),flight_passengers_tpl:this.$el.find("#flight_passengers_tpl"),flight_passengers_box:this.$el.find("#flight_passengers_box"),flight_paypanel_tpl:this.$el.find("#flight_paypanel_tpl"),flight_paypanel_box:this.$el.find("#flight_paypanel_box"),expressstatus_tpl:this.$el.find("#expressstatus_tpl")},this.flight_info_fun=_.template(this.elsBox.flight_info_tpl.html()),this.flight_fly_fun=_.template(this.elsBox.flight_fly_tpl.html()),this.flight_passengers_fun=_.template(this.elsBox.flight_passengers_tpl.html()),this.flight_paypanel_fun=_.template(this.elsBox.flight_paypanel_tpl.html()),this.expressstatus_fun=_.template(this.elsBox.expressstatus_tpl.html())},renderData:function(a){var b=this;a.cDate=n.Date,a.num2Chnum=H;try{a.deliverys&&a.deliverys[0]&&a.deliverys[0].extinfo&&2===a.deliverys[0].extinfo.paytype?(a.isLiPinKa=!0,a.lpkAmt=a.deliverys[0].extinfo.amount,a.returnAmt=a.flttick&&a.flttick.acamt||0):a.flttick&&a.flttick.thamt>0?(a.isLiPinKa=!0,a.lpkAmt=a.flttick.thamt||0,a.returnAmt=a.flttick.acamt||0):a.isLiPinKa=!1}catch(c){0}var d=b.flight_info_fun(a);b.elsBox.flight_info_box.html(d);var e=b.flight_fly_fun(a);b.elsBox.flight_fly_box.html(e);var f=b.flight_passengers_fun(a);b.elsBox.flight_passengers_box.html(f);var g=b.flight_paypanel_fun(a);b.elsBox.flight_paypanel_box.html(g),b.exhtml&&b.$el.find(".js_expressStatus").append(b.exhtml)},backAction:function(){if(p&&p.remove(),this.removeOrderStore=!0,C=B.getUser(),C&&C.Auth)this.jump("flight_order_list"==this.backUrl?"/webapp/myctrip/index.html#orders/flightorderlist":"/webapp/myctrip/index.html#orders/unuseorderlist"==this.backUrl?"/webapp/myctrip/index.html#orders/unuseorderlist":this.backUrl.indexOf("orderresults")>0?"/webapp/flight/index.html#orderresults?rc=0&orderid="+A:this.backUrl.indexOf("flight/#bookinginfo")>0?this.backUrl:"flight_order_list"!=this.backUrl&&""!=this.backUrl&&null!=this.backUrl?this.backUrl:"/webapp/myctrip/index.html#orders/flightorderlist");else{var a=o.get();a&&a.sid&&(1575==+a.sid||1867==+a.sid||449843==+a.sid)?this.jump("/webapp/flight/index.html"):a&&a.sid&&1896==+a.sid?window.location="map://leftClick()":this.jump(this.homeUrl)}},rebateAction:function(a){var b=$(a.currentTarget),d=b.attr("data-rebate"),e=b.attr("data-code");if(d&&+d>0&&e&&e.trim().length>0){var f=e.split("|")[0];this.fxAlert=new c.ui.Alert({title:"返现提示",message:"1.在微信中查找“携程旅行网”加关注</br>2.在聊天输入框中输入验证码“"+f+"”后发送",buttons:[{text:"确定",click:function(){this.hide()}},{text:"去下载",click:function(){var a=window.navigator.userAgent;if(a){a=a.toLowerCase();var b="http://weixin.qq.com/m",c="https://itunes.apple.com/cn/app/id414478124?mt=8&ls=1";a.indexOf("android")>-1?(this.hide(),window.location=b):a.indexOf("iphone")>-1?(this.hide(),window.location=c):this.hide()}else this.hide()}}]}),this.fxAlert.show()}},events:{"click .jstgq":"showTgq","click #jsRebateAmt":"rebateAction","click #modifyorder":"modifyorder","click #flightticketrefund":"ticketrefund","click .jsexpstatlistp":"expressStatusList","click #cancelorder":"showCancelAlert","click #flightzj":"jumpCheckin","click #payagain":"showDialog4PayAgain"},jumpCheckin:function(){z.setAttr("backurl","/webapp/flight/index.html#flightorderdetail?oid="+A),$("#headerview").hide(),this.jump("/webapp/flight/#CheckInList")},expressStatusList:function(a){var b=$(a.currentTarget);b.toggleClass("current"),b.hasClass("current")?b.next(".jsexpstatlist").show():b.next(".jsexpstatlist").hide()},showCancelAlert:function(a){var b=$(a.currentTarget),d=b.attr("data-oid"),e=b.attr("data-flag");if(4==(4&e)&&null!=d&&""!=d){var f=this;f.cancelAlert=new m.Alert({showTitle:!0,title:"提示信息",message:"确定要取消订单吗？",buttons:[{text:"取消订单",click:function(){this.hide(),f.cancelFlightOrder(d)},type:c.ui.Alert.STYLE_CANCELSTYLE_CONFIRM},{text:"点错了",click:function(){this.hide()},type:c.ui.Alert.STYLE_CANCEL||"cancel"}]}),f.cancelAlert.show()}},cancelFlightOrder:function(a){var b=this;0,""!=a&&(b.showLoading(),v.setParam("oid",a),v.excute(function(a){b.hideLoading(),0,a&&1==a.res?(b.sucAlert=new m.Alert({showTitle:!0,title:"提示信息",message:"订单取消成功",buttons:[{text:"知道了",click:function(){this.hide(),location.reload()}}]}),b.sucAlert.show()):(b.errAlert=new m.Alert({showTitle:!0,title:"提示信息",message:"您的订单已无法取消，如有疑问请您拨打客服电话",buttons:[{text:"拨打电话",click:function(){$("#c-ui-header-tel").click(),this.hide()},type:c.ui.Alert.STYLE_CANCELSTYLE_CONFIRM},{text:"确定",click:function(){this.hide(),location.reload()},type:c.ui.Alert.STYLE_CANCEL||"cancel"}]}),b.errAlert.show())},function(){b.hideLoading(),b.hideWarning404(),b.showWarning404(function(){b.hideWarning404(),location.reload()})},!0,this,function(){b.hideLoading(),b.hideWarning404(),b.showWarning404(function(){b.hideWarning404(),location.reload()})}))},ticketrefund:function(){this.removeOrderStore=!1,this.tripType&&this.forward(1==this.tripType?"ticketrefundsingle":"ticketrefundmultiple")},modifyorder:function(){this.removeOrderStore=!1,this.forward("flightordermodify")},showTgq:function(a){var b=$(a.currentTarget),c=b.next("div");b.hasClass("flight-arrdown")?(c.removeClass("js_hide"),b.removeClass("flight-arrdown").addClass("flight-arrup")):(c.addClass("js_hide"),b.removeClass("flight-arrup").addClass("flight-arrdown"))},showDialog4PayAgain:function(){var a=this,b=r.get();if(null!=b){for(var d={},e=0;e<b.repays.length;e++){var f=b.repays[e];if(null!=f.repaytyp&&null!=f.extno){d=f;break}}var g=b.id,h=d.extno||"",i={ver:"99",ooption:1,oid:g,extno:h},j=b.relorders;if(null!=j&&j.length>0){var k="<p>支付金额: ￥"+amt+"</p>";k+="<p>提交订单时，系统自动拆分成多张订单:</p>",k+="<p>订单"+b.id+"</p>";for(var e=0;e<j.length;e++)k+="<p>订单"+j[e].oid+"</p>";k+="<p>支付总额为以上订单应付款总和</p>",a.payAgainAlert=new m.Alert({message:k,buttons:[{text:"返回",click:function(){this.hide()},type:c.ui.Alert.STYLE_CANCEL||"cancel"},{text:"支付",click:function(){this.hide(),a.jumpToPaymentV2(i)},type:c.ui.Alert.STYLE_CANCELSTYLE_CONFIRM}]}),a.payAgainAlert.show()}else a.jumpToPaymentV2(i)}},jumpToPaymentV2:function(a){var b=this;if(null!=a){for(var c=r.get(),d={},e=0;e<c.repays.length;e++){var f=c.repays[e];if(null!=f.repaytyp&&null!=f.extno){d=f;break}}var g=c.id,h=(d.extno||"",d.billno||"",d.amt||0),i=(B.getUser().Auth,101),k=(B.getUser().Auth,function(a){for(var b="",c=0;a>c;c++)b+=Math.floor(10*Math.random());return b}),l=k(19);b.showLoading(),y.setParam(a),0,y.excute(function(a){if(b.hideLoading(),0,a)if(0==a.rc){var d=a.rltvlu,e={oid:g,bustype:i,from:location.href,sback:location.origin+"/webapp/flight/#orderresults?rc=0&type=flight&orderid="+g,eback:location.origin+"/webapp/flight/#orderresults?rc=1&type=flight&orderid="+g,rback:location.origin+"/webapp/flight/#orderresults?rc=2&type=flight&orderid="+g,auth:B.getUser().Auth,title:"机票订单",currency:"CNY",amount:h,extno:d,islogin:B.isNonUser()?1:0,requestid:l},f=c.delivery&&"不需要报销凭证"!=c.delivery;1==f&&(e.needInvoice=!0,e.invoiceDeliveryFee=c.deliveryFee||0,e.includeInTotalPrice=!0);var k=j.Base64.encode(JSON.stringify(e)),m=location.host,n="https://secure.ctrip.com/webapp/payment2/index.html#index?";if(n=m.match(/^(localhost|172\.16|127\.0)/i)?"https://secure.fws.qa.nt.ctripcorp.com/webapp/payment2/index.html#index?":m.match(/^m.fat/i)||m.match(/^m.test/i)?"https://secure.fws.qa.nt.ctripcorp.com/webapp/payment2/index.html#index?":m.match(/^m\.uat\.qa/i)?"https://secure.uat.sh.ctriptravel.com/webapp/payment2/index.html#index?":m.match(/10.\8/gi)?"https://10.8.5.10/webapp/payment2/index.html#index?":"https://secure.ctrip.com/webapp/payment2/index.html#index?",n+="oid="+g+"&bustype="+i+"&token="+k,E.getAttr("isCCB")){var o=E.get().osType,p=E.get().osVer,q={osType:o,osVersion:p,payWayWhiteList:"EB_CCB"},r=j.Base64.encode(JSON.stringify(q));n+="&extend="+r}if(E.getAttr("isCCB")){var o=E.get().osType,p=E.get().osVer,q={osType:o,osVersion:p,payWayWhiteList:"EB_CCB"},r=j.Base64.encode(JSON.stringify(q));n+="&extend="+r}b.jump(n)}else{var s=a.rmsg||"网络不给力,请稍后再试试吧";b.showToast(s)}},function(a){b.hideLoading();var c=a.msg||"网络不给力,请稍后再试试吧";b.showToast(c)},!0,y,function(){b.hideLoading(),b.showWarning404(function(){location.reload()})})}},onCreate:function(){this.injectHeaderView(),this.render()},onShow:function(){this.setTitle("订单详情"),this.showOutHeader()},onLoad:function(){var a=this,b=o.get();if(b&&b.sid&&(1575==+b.sid||1867==+b.sid)&&(this.$el.find("#footer").hide(),this.footer&&this.footer.hide(),this.hasAd=!1),C=B.getUser(),0,null!=C&&null!=C.Auth&&""!=C.Auth){0;{var c=p.get();this.request.query.from}this.request.query.oid?(0,u.setParam("id",parseInt(this.request.query.oid)),a.backUrl="flight_order_list",p.setAttr({Id:parseInt(this.request.query.oid),url:"flight_order_list"}),a.getFlightOrderDetail(parseInt(this.request.query.oid)),A=parseInt(this.request.query.oid),this.xiaoMiHuangYe(this.request.query.oid)):c&&c.Id?(u.setParam("id",c.Id),A=c.Id,t.remove(),s.remove(),s.setAttr("oid",c.Id),null!=c.url&&(a.backUrl=c.url),a.getFlightOrderDetail(c.Id),this.xiaoMiHuangYe(c.Id)):(a.backUrl="flight_order_list",a.backAction())}else if(l.isInApp())a.showWarning404(function(){location.reload()});else{var d="/webapp/myctrip/#account/login?from="+encodeURIComponent(this.getRoot()+"#flightorderdetail");this.request.query.oid&&(d+="?oid="+this.request.query.oid,this.getQuery("openapp")&&(d+="&openapp="+this.getQuery("openapp")),this.getQuery("downapp")&&(d+="&downapp="+this.getQuery("downapp")),this.getQuery("sourceid")&&(d+="&sourceid="+this.getQuery("sourceid")));var b=o.get();b&&b.sid&&(1575==+b.sid||1867==+b.sid)&&(d="/webapp/flight/index.html"),a.jump(d)}this.getSalesObj()},getSalesObj:function(){var b=this,c=b.getQuery("sales"),e=b.getQuery("sourceid"),f=d.SalesStore.getInstance().get();null!=f&&null==e&&null==c&&(e=f.sourceid),(c||e)&&a.getSalesObject(c||e,$.proxy(function(){a.replaceContent(b.$el)},this))},onHide:function(){q.abort(),u.abort(),this.elsBox.flight_info_box.empty(),this.elsBox.flight_fly_box.empty(),this.elsBox.flight_passengers_box.empty(),this.elsBox.flight_paypanel_box.empty(),this.hideLoading(),this.hideWarning404(),v.abort()},hideOutHeader:function(){this.$headerview=this.$headerview?this.$headerview:$("#headerview"),this.$headerview.length>0&&this.$headerview.hide()},showOutHeader:function(){this.$headerview=this.$headerview?this.$headerview:$("#headerview"),this.$headerview.length>0&&this.$headerview.show()},xiaoMiHuangYe:function(a){var b=JSON.parse(window.localStorage.getItem("SALES")),c={};if(b&&b.data&&1575==+parseInt(b.data.sourceid)){var d=JSON.parse(window.localStorage.getItem("XIAOMI_TOKEN"));d&&(c.appk="5311722679795",c.clid="2882303761517226795",c.actk=d.access_token,c.mcky=d.mac_key,c.oridurl="http://"+window.location.host+"/webapp/fltintl/#fltintlorderdetail?oid=",c.orid=a,c.btype=101,x.setParam(c),x.excute(function(){},function(){},this.false))}},getFlightOrderDetail:function(a){var b=this;b.showLoading(),w.setParam({qinfo:[{oid:a,biztype:1}]}),w.excute(function(a){a.cDate=n.Date,b.exhtml=b.expressstatus_fun(a),b.$el.find(".js_expressStatus").length>0&&(b.$el.find(".js_expressStatus").append(b.exhtml),b.exhtml=null)},function(){},!1,b,function(){}),this.hideOutHeader(),u.excute(function(a){0,a.cBase=n;var c=!1;if(G.call(b,a,D),b.headerview.set({title:"订单详情",back:!0,view:b,tel:{number:4000086666},home:c,events:{homeHandler:function(){b.jump("/html5/")},returnHandler:function(){b.backAction()}}}),b.headerview.show(),b.turning(),null!=a.passengers&&0==a.passengers.length&&(b.hideLoading(),this.getQuery("oid")?b.showToast("订单查询失败。",1,function(){var a=o.get();a&&a.sid&&1896==+a.sid?window.location="map://leftClick()":b.jump(b.homeUrl)}):b.showWarning404(function(){b.hideWarning404(),b.onLoad()})),null!=a){null!=a.passengers&&0==a.passengers.length&&(b.hideLoading(),this.getQuery("oid")?b.showToast("订单查询失败。",1,function(){var a=o.get();a&&a.sid&&1896==+a.sid?window.location="map://leftClick()":b.jump(b.homeUrl)}):b.showWarning404(function(){b.hideWarning404(),b.onLoad()}));var d=!1;if(null!=a.flightInfos){for(var e=!1,f=0;f<a.flightInfos.length;f++){var g=a.flightInfos[f].flag;1024==(1024&g)&&(e=!0,d=!0)}a.isZJ=e}if(null!=a.flag&&(8==(8&a.flag)||32==(32&a.flag)||64==(64&a.flag))&&(d=!0),"undefined"!=typeof a.repays&&null!=a.repays)for(var f=0;f<a.repays.length;f++){var h=a.repays[f];if(1==h.repaytyp||3==h.repaytyp){a.payAgain=!0,d=!0;break}}a.isShowBtnDiv=d,0===a.amt&&0===a.passengers.length||q.excute(function(c){b.hideLoading(),c&&(a.aircraft=c,a.iinfo="undefined"!=typeof a.iinfo&&null!=a.iinfo?a.iinfo:{},b.renderData(a))},function(){b.hideLoading(),a.aircraft=null,b.renderData(a)})}else b.hideLoading(),b.showWarning404(function(){location.reload()})},function(){b.hideLoading(),b.showWarning404(function(){location.reload()})},this.removeOrderStore,this,function(){b.hideLoading(),b.showWarning404(function(){location.reload()})})}}),G=function(a,b){for(key in a)"undefined"==typeof a[key]||null==a[key]?a[key]=b[key]:"object"==typeof a[key]&&(b[key]=b[key]||{},G(a[key],b[key]));return this.tripType=a.tripType,a.flightInfos&&a.flightInfos.length>1&&1==a.tripType&&(a.tripType=4),a},H=function(a){var b=a+"",c=b.split(""),d="",e=["","十","百","千","万"],f=["o","一","二","三","四","五","六","七","八","九"],g=c.length;for(i=1;g>=i;i++)d=0==~~c[g-i]?f[~~c[g-i]]+d:f[~~c[g-i]]+e[i-1]+d;return d=d.replace(/(.)\1+/,"$1"),d=d.replace(/o$/,""),"一十"==d&&(d="十"),d.replace("o","零")};return F});