define(["cSales","libs","c","CommonStore","FlightStore","FlightModel","cBasePageView",buildViewTemplatesPath("ticketrefundmultiple.html"),"cUtility","cWidgetFactory","cWidgetGuider"],function(a,b,c,d,e,f,g,h){var j=d.SalesObjectStore.getInstance(),k=d.UserStore.getInstance(),l=e.FlightOrderParamStore.getInstance(),m=e.FlightOrderDetailStore.getInstance(),n=e.FlightTicketRefundFormStore.getInstance(),o=f.FlightTicketRefundChangeModel.getInstance(),p=f.FlightTicketRefundModel.getInstance(),q=e.TempSaveDataStore.getInstance(),r=c.ui,s=c.base,t=k.getUser(),u="退票申请",v={num2Cnum:function(a){var b=a+"",c=b.split(""),d="",e=["","十","百","千","万"],f=["o","一","二","三","四","五","六","七","八","九"],g=c.length;for(i=1;g>=i;i++)d=0==~~c[g-i]?f[~~c[g-i]]+d:f[~~c[g-i]]+e[i-1]+d;return d=d.replace(/(.)\1+/,"$1"),d=d.replace(/o$/,""),"一十"==d&&(d="十"),d.replace("o","零")}},w={viewData:{},getRefundChangeInfo:function(a){var b=l.get(),c=m.get();if(c&&b&&b.Id)o.setParam("flag",0),o.setParam("reqtype",1),o.setParam("oid",b.Id),x.backUrl=b.url||x.backUrl,a.showLoading(),o.excute(function(b){if(w.checkData(b))if(b.segs[0].psgs=w.passengerSort(b.segs[0].psgs),a.hideLoading(),b.viewHelper=v,w.viewData=b,b&&b.head&&0==b.head.errcode){var d=n.get()||{};d.segs=d.segs||[],b.selectedSegs=d.segs,b.orderDetail=c,a.turning(),a.renderData(b)}else a.showWarning404(function(){location.reload()});else a.hideLoading(),a.showWarning404(function(){location.reload()})},function(){a.hideLoading(),a.showWarning404(function(){location.reload()})},!0,this,function(){a.hideLoading(),a.showWarning404(function(){location.reload()})});else{var d=j.get();d&&d.sid&&1896==+d.sid?window.location="map://leftClick()":a.jump(a.homeUrl)}},passengerSort:function(a){var b=a.length,c=[],d=function(a,b){a=a||c.length,c[a]=c[a]||[],c[a].push(b)},e={"未使用":1,"已退票":4,"使用":6,"退票申请中":9,"改签申请中":8,"已过期":7,"退票办理中":10,"已退票待退款":11,"未确定":2,"退票":5},f=function(){for(var f,g=[],h=0;b>h;h++){var i=a[h];f=e[i.status],d(f,i),i.status=w.getStatusText(i.status)}for(var j=0;j<c.length;j++)c[j]&&(g=g.concat(c[j]));return g};return f()},getStatusText:function(a){var b={"未使用":"","已退票":"已退票","使用":"已使用","退票申请中":"退票申请中","改签申请中":"改签申请中","已过期":"已过期","退票办理中":"退票办理中","已退票待退款":"已退票待退款","未确定":"","退票":"已退票"};return b[a]||""},checkData:function(a){try{if(a.tktinfo&&a.tktinfo.expired&&a.segs)return a.segs.length>0?!0:!1}catch(b){return this.hideLoading(),this.showToast(b.message),!1}}},x=g.extend({pageid:"214392",tpl:h,hasAd:!0,homeUrl:"/html5",render:function(){this.$el.html(this.tpl),this.elsBox={ticketRefund_morePath_tpl:this.$el.find("#ticketRefund_morePath_tpl"),ticketRefund_morePath_box:this.$el.find("#ticketRefund_morePath_box")},this.ticketRefund_morePath_creater=_.template(this.elsBox.ticketRefund_morePath_tpl.html())},renderData:function(a){var b=this;a.cDate=s.Date;var c=m.get();a.flightInfos=c.flightInfos,0;var d=b.ticketRefund_morePath_creater(a);b.elsBox.ticketRefund_morePath_box.html(d),null!=q.getAttr("ticketRefund_morePath_tpl_comment")&&""!=q.getAttr("ticketRefund_morePath_tpl_comment")&&$("#ticketRefund_morePath_tpl_comment").val(q.getAttr("ticketRefund_morePath_tpl_comment"))},backAction:function(){if(t=k.getUser(),t&&t.Auth)this.back("flightorderdetail");else{var a=j.get();a&&a.sid&&1896==+a.sid?window.location="map://leftClick()":this.jump(this.homeUrl),q.remove()}},events:{"click .js_selectPassenger":"selectPassenger","click #ticketRefund_morePath_submit":"showAlert","click .js_checkbox":"checkboxAction"},onCreate:function(){if(!l.get()){var a=j.get();a&&a.sid&&1896==+a.sid?window.location="map://leftClick()":this.jump(this.homeUrl)}this.injectHeaderView(),this.render()},onShow:function(){this.setTitle(u)},onLoad:function(){var a=this,b=!0,c=j.get();c&&c.sid&&(1575==+c.sid||1867==+c.sid)&&(b=!1),a.headerview.set({title:u,back:!0,view:a,tel:{number:4000086666},home:b,events:{homeHandler:function(){var b=j.get();b&&b.sid&&1896==+b.sid?window.location="map://leftClick()":a.jump(a.homeUrl),q.remove()},returnHandler:function(){a.backAction(),q.remove()}}}),a.headerview.show(),t=k.getUser(),w.getRefundChangeInfo(a,function(b,c){a.hideLoading(),a.renderData(c)}),this.getSalesObj()},getSalesObj:function(){var b=this,c=b.getQuery("sales"),e=b.getQuery("sourceid"),f=d.SalesStore.getInstance().get();null!=f&&null==e&&null==c&&(e=f.sourceid),(c||e)&&a.getSalesObject(c||e,$.proxy(function(){a.replaceContent(b.$el)},this))},onHide:function(){this.hideLoading(),this.hideWarning404()},selectPassenger:function(a){""!=$("#ticketRefund_morePath_tpl_comment").val()&&q.setAttr("ticketRefund_morePath_tpl_comment",$("#ticketRefund_morePath_tpl_comment").val());var b=this,c=$(a.currentTarget),d=c.attr("data-segid");b.forward("ticketrefundselectpassenger?segid="+d)},popup:function(){var a=this;return new r.Alert({title:"提示信息",message:"",showTitle:!0,buttons:[{text:"取消",click:function(){this.hide()},type:c.ui.Alert.STYLE_CANCEL},{text:"确认",click:function(){this.hide(),a.submit()},type:c.ui.Alert.STYLE_CANCELSTYLE_CONFIRM}]})},submit:function(){var a=this;a.showLoading(),p.excute(function(){a.hideLoading(),q.remove(),a.forward("ticketrefundsucceed")},function(b){n.remove(),a.hideLoading(),a.showToast(b.msg)})},showAlert:function(){for(var a,b,c=this,d=w.viewData.selectedSegs||[],e=l.get(),f={oid:e.Id,flag:0,segs:[],continfo:{comment:$("#ticketRefund_morePath_tpl_comment").val(),name:w.viewData.tktinfo.name,phone:w.viewData.tktinfo.phone}},g=0,h=0,i=0,j=0,k=0;k<d.length;k++){var m=d[k];if(m&&m.psgs)for(var n=0;n<m.psgs.length;n++){var o=m.psgs[n];if(o){g++;var q={segid:m.segid,psgname:o.name,svrs:[]},r=$("#ticketRefund_morePath_service").hasClass("checkbox_bs_checked");r&&q.svrs.push({svrtype:o.svrs.type,svruser:o.svrs.user,cnt:o.svrs.arg}),f.segs.push(q),h+=Math.round(o.pay.refundfee)||0,i+=Math.round(o.pay.insamount)||0,j+=Math.round(o.pay.fee)||0,a=a||o.pay.refundremark,b=b||o.pay.refundtype}}}p.setParam(f);var s=function(){if(0==arguments.length)return"";if(1==arguments.length)return arguments[0];var a=/{(\d+)?}/g,b=arguments,c=arguments[0].replace(a,function(a,c){return b[parseInt(c)+1]});return c},t=(w.viewData.orderDetail,[]);switch(b){case 1:t.push("<div class='p10'>"),t.push(s("<p>收取退票费：&yen;{0}</p>",h)),i&&t.push(s("<p>已生效保险：&yen;{0}</p>",i)),j&&t.push(s("<p>外卡费用：&yen;{0}</p>",j)),t.push(s("<p>收取费用总计：&yen;{0}</p>",h+i+j)),t.push(s("点击确认后我们将开始为您处理退票，确认提交吗？")),t.push("</div>");break;case 2:t.push("<div class='p10'>"),t.push(s("<p>收取退票费：&yen;{0}</p>",h)),i&&t.push(s("<p>已生效保险：&yen;{0}</p>",i)),t.push(a),t.push(s("点击确认后我们将开始为您处理退票，确认提交吗？")),t.push("</div>");break;case 3:t.push("<div class='p10'>"),t.push(a),t.push(s("点击确认后我们将开始为您处理退票，确认提交吗？")),t.push("</div>")}var u=c.popup();u.setViewData({message:t.join(""),title:"提示信息"}),g>0?u.show():(c.showToast("请至少选择一个登机人"),$("li.js_selectPassenger").each(function(a,b){$(b).addClass("highlight")}))},getFlightTicketRefundChangeSearch:function(){var a=this;a.showLoading();var b={};a.hideLoading(),a.renderData(b)},checkboxAction:function(a){var b=$(a.currentTarget);if(b.hasClass("flt_discheck"))return!1;var c=b.find("label"),d=c.hasClass("checkbox_wrap_b")?"checkbox_b_checked":"checkbox_bs_checked",e=c.hasClass(d)?"removeClass":"addClass";c[e](d)}});return x});