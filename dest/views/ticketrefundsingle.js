define(["cSales","libs","c","CommonStore","FlightStore","FlightModel","cBasePageView",buildViewTemplatesPath("ticketrefundsingle.html"),"cUtility","cWidgetFactory","cWidgetGuider"],function(a,b,c,d,e,f,g,h){var i=d.SalesObjectStore.getInstance(),j=d.UserStore.getInstance(),k=f.FlightTicketRefundChangeModel.getInstance(),l=e.FlightOrderParamStore.getInstance(),m=f.FlightTicketRefundModel.getInstance(),n=e.FlightOrderDetailStore.getInstance(),o=c.ui,p=c.base,q=j.getUser(),r={PAGETITLE:"退票申请"},s={viewData:{},stringFormat:function(){if(0==arguments.length)return"";if(1==arguments.length)return arguments[0];var a=/{(\d+)?}/g,b=arguments,c=arguments[0].replace(a,function(a,c){return b[parseInt(c)+1]});return c},getRefundChangeInfo:function(a){var b=l.get(),c=n.get();c&&b&&b.Id?(a.backUrl=b.url||a.backUrl,a.showLoading(),k.setParam("flag",0),k.setParam("reqtype",1),k.setParam("oid",b.Id),k.excute(function(b){s.checkData(b)?(a.hideLoading(),b.segs[0].psgs=s.passengerSort(b.segs[0].psgs),s.viewData=b,b&&b.head&&0==b.head.errcode?(b.orderDetail=c,a.turning(),a.renderData(b)):a.showWarning404(function(){location.reload()})):(a.hideLoading(),a.showWarning404(function(){location.reload()}))},function(){a.hideLoading(),a.showWarning404(function(){location.reload()})},!0,a,function(){a.hideLoading(),a.showWarning404(function(){location.reload()})})):a.jump(a.homeUrl)},passengerSort:function(a){var b=a.length,c=[],d=function(a,b){a=a||c.length,c[a]=c[a]||[],c[a].push(b)},e={"未使用":1,"已退票":4,"使用":6,"退票申请中":9,"改签申请中":8,"已过期":7,"退票办理中":10,"已退票待退款":11,"未确定":2,"退票":5},f=function(){for(var f,g=[],h=0;b>h;h++){var i=a[h];f=e[i.status],d(f,i),i.status=s.getStatusText(i.status)}for(var j=0;j<c.length;j++)c[j]&&(g=g.concat(c[j]));return g};return f()},getStatusText:function(a){var b={"未使用":"","已退票":"已退票","使用":"已使用","退票申请中":"退票申请中","改签申请中":"改签申请中","已过期":"已过期","退票办理中":"退票办理中","已退票待退款":"已退票待退款","未确定":"","退票":"已退票"};return b[a]||a},checkData:function(a){try{if(a.tktinfo&&a.tktinfo.expired&&a.segs)return a.segs.length>0?!0:!1}catch(b){return this.hideLoading(),this.showToast(b.message),!1}}},t=g.extend({pageid:"214393",tpl:h,hasAd:!0,homeUrl:"/html5",render:function(){this.$el.html(this.tpl),this.elsBox={ticketRefund_onePath_tpl:this.$el.find("#ticketRefund_onePath_tpl"),ticketRefund_box:this.$el.find("#ticketRefund_box")},this.ticketRefund_tpl_creater=_.template(this.elsBox.ticketRefund_onePath_tpl.html())},renderData:function(a){var b=this;a.cDate=p.Date;var c=n.get();a.flightInfos=c.flightInfos;var d=b.ticketRefund_tpl_creater(a);b.elsBox.ticketRefund_box.html(d)},backAction:function(){if(q=j.getUser(),q&&q.Auth)this.back("flightorderdetail");else{var a=i.get();a&&a.sid&&1896==+a.sid?window.location="map://leftClick()":this.jump(this.homeUrl)}},events:{"click #searchlistsubmit":"showAlert","click .js_checkbox":"checkboxAction"},onCreate:function(){l.get()||this.jump(this.homeUrl),this.injectHeaderView(),this.render()},onShow:function(){this.setTitle(r.PAGETITLE)},onLoad:function(){var a=this,b=!0,c=i.get();c&&c.sid&&(1575==+c.sid||1867==+c.sid)&&(b=!1),a.headerview.set({title:r.PAGETITLE,back:!0,view:a,tel:{number:4000086666},home:b,events:{homeHandler:function(){var b=i.get();b&&b.sid&&1896==+b.sid?window.location="map://leftClick()":a.jump(a.homeUrl)},returnHandler:function(){a.backAction()}}}),a.headerview.show(),s.getRefundChangeInfo(a,function(){}),this.getSalesObj()},getSalesObj:function(){var b=this,c=b.getQuery("sales"),e=b.getQuery("sourceid"),f=d.SalesStore.getInstance().get();null!=f&&null==e&&null==c&&(e=f.sourceid),(c||e)&&a.getSalesObject(c||e,$.proxy(function(){a.replaceContent(b.$el)},this))},onHide:function(){this.hideLoading(),this.hideWarning404()},popup:function(){var a=this;return new o.Alert({title:"提示信息",message:"",showTitle:!0,buttons:[{text:"取消",click:function(){this.hide()},type:c.ui.Alert.STYLE_CANCEL},{text:"确认",click:function(){this.hide(),a.submit()},type:c.ui.Alert.STYLE_CANCELSTYLE_CONFIRM}]})},submit:function(){var a=this;a.showLoading(),m.excute(function(){a.hideLoading(),a.forward("ticketrefundsucceed")},function(b){a.hideLoading(),a.showToast(b.msg)})},showAlert:function(){var a,b,c=this,d=$(".js_passenger.checkbox_b_checked"),e=l.get(),f={oid:e.Id,flag:0,segs:[],continfo:{comment:$("#comment").val(),name:s.viewData.tktinfo.name,phone:s.viewData.tktinfo.phone}},g=0,h=0,i=0;d.each(function(c){var d=s.viewData.segs[0],e=d.psgs[c],j={segid:d.segid,psgname:e.name,svrs:[]},k=$("#js_ticketRefund_onePath_refundSVR").hasClass("checkbox_bs_checked");if(k&&j.svrs.push({svrtype:e.svrs.type,svruser:e.svrs.user,cnt:e.svrs.arg}),1==s.viewData.tktinfo.triptype&&s.viewData.segs.length>1)for(var l in s.viewData.segs)j.segid=s.viewData.segs[l].segid,f.segs.push({segid:s.viewData.segs[l].segid,psgname:j.name,svrs:j.svrs});else f.segs.push(j);g+=Math.round(e.pay.refundfee)||0,h+=Math.round(e.pay.insamount)||0,i+=Math.round(e.pay.fee)||0,a=a||e.pay.refundremark,b=b||e.pay.refundtype}),m.setParam(f);{var j=s.stringFormat,k=s.viewData.orderDetail;k.flightInfos[0]}"收费快递"==n.getAttr("delivery")&&(b=2,a=a?"":"<p>其他费用待定</p>");var o=[];switch(b){case 1:o.push("<div class='p10'>"),o.push(j("<p>收取退票费：&yen;{0}</p>",g)),h&&o.push(j("<p>已生效保险：&yen;{0}</p>",h)),i&&o.push(j("<p>外卡费用：&yen;{0}</p>",i)),o.push(j("<p>收取费用总计：&yen;{0}</p>",g+h+i)),o.push(j("点击确认后我们将开始为您处理退票，确认提交吗？")),o.push("</div>");break;case 2:o.push("<div class='p10'>"),o.push(j("<p>收取退票费：&yen;{0}</p>",g)),h&&o.push(j("<p>已生效保险：&yen;{0}</p>",h)),o.push(a),o.push(j("点击确认后我们将开始为您处理退票，确认提交吗？")),o.push("</div>");break;case 3:o.push("<div class='p10'>"),o.push(a),o.push(j("点击确认后我们将开始为您处理退票，确认提交吗？")),o.push("</div>")}var p=c.popup();p.setViewData({message:o.join(""),title:"提示信息"}),d.size()>0?p.show():(c.showToast("请至少选择一个登机人"),$("li.js_checkbox:not(.flt_discheck)").each(function(a,b){$(b).addClass("highlight")}))},checkboxAction:function(a){var b=$(a.currentTarget);if(b.hasClass("flt_discheck"))return!1;var c=b.find("label"),d=c.hasClass("checkbox_wrap_b")?"checkbox_b_checked":"checkbox_bs_checked",e=c.hasClass(d)?"removeClass":"addClass";c[e](d)}});return t});